<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="./manifest.json" />
<title>MFS v3</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-slate-100">
<div id="app" class="max-w-3xl mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">Mijn Films en Series</h1>
  <div class="flex gap-2 mb-4">
    <button id="btn-import-json" class="px-3 py-2 rounded bg-white shadow">Importeer JSON</button>
    <button id="btn-import-csv" class="px-3 py-2 rounded bg-white shadow">Importeer CSV (IMDb)</button>
    <button id="btn-add-demo" class="px-3 py-2 rounded bg-indigo-600 text-white shadow">Demo-items</button>
    <button id="btn-fill-posters" class="px-3 py-2 rounded bg-emerald-600 text-white shadow">Posters aanvullen</button>
    <input id="omdb-key" type="password" placeholder="OMDb API key" class="px-3 py-2 rounded bg-white shadow w-44 hidden" />
  </div>
  <div id="filterControls" class="flex gap-2 mb-3">
    <button class="filter-btn px-3 py-1.5 rounded bg-white" data-filter="film">Films</button>
    <button class="filter-btn px-3 py-1.5 rounded bg-white" data-filter="serie">Series</button>
    <button class="filter-btn px-3 py-1.5 rounded bg-white" data-filter="aan-het-kijken">Aan het kijken</button>
    <button class="filter-btn px-3 py-1.5 rounded bg-white" data-filter="bekeken">Bekeken</button>
    <button class="filter-btn px-3 py-1.5 rounded bg-white" data-filter="all">Alles</button>
    <input id="search" class="px-3 py-2 rounded bg-white ml-auto" placeholder="Zoeken…" />
  </div>
  <div id="list" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
  <p id="emptyState" class="hidden text-center text-slate-600 py-10">Laden…</p>
</div>
<script>
const OMDB_DEFAULT_KEY='8a70a767';
const DB_NAME='mfs-db';const DB_VERSION=1;const STORE='items';
function openDB(){return new Promise((resolve,reject)=>{const req=indexedDB.open(DB_NAME,DB_VERSION);req.onupgradeneeded=()=>{const db=req.result;if(!db.objectStoreNames.contains(STORE)){const store=db.createObjectStore(STORE,{keyPath:'id'});store.createIndex('createdAt','createdAt');store.createIndex('type','type');}};req.onsuccess=()=>resolve(req.result);req.onerror=()=>reject(req.error);});}
function tx(db,mode='readonly'){return db.transaction(STORE,mode).objectStore(STORE);}
async function dbGetAll(){const db=await openDB();return new Promise((res,rej)=>{const r=tx(db).getAll();r.onsuccess=()=>res(r.result||[]);r.onerror=()=>rej(r.error);});}
async function dbPut(item){const db=await openDB();return new Promise((res,rej)=>{const r=tx(db,'readwrite').put(item);r.onsuccess=()=>res();r.onerror=()=>rej(r.error);});}
async function dbBulkPut(items){const db=await openDB();return new Promise((res,rej)=>{const store=tx(db,'readwrite');items.forEach(i=>store.put(i));store.transaction.oncomplete=()=>res();store.transaction.onerror=()=>rej(store.transaction.error);});}
const app={state:{items:[],filter:'all',searchTerm:'',isDbReady:false},
async init(){this.cacheEls();this.bindUI();try{await openDB();this.state.isDbReady=true;this.state.items=await dbGetAll();this.render();}catch(e){console.error(e);}if('serviceWorker'in navigator){navigator.serviceWorker.register('./sw.js').catch(console.warn);}},
cacheEls(){this.$list=document.getElementById('list');this.$emptyState=document.getElementById('emptyState');this.$filterControls=document.getElementById('filterControls');this.$search=document.getElementById('search');this.$btnImport=document.getElementById('btn-import-json');this.$btnImportCSV=document.getElementById('btn-import-csv');this.$btnDemo=document.getElementById('btn-add-demo');this.$btnFillPosters=document.getElementById('btn-fill-posters');this.$omdbKey=document.getElementById('omdb-key');},
bindUI(){this.$filterControls.addEventListener('click',(e)=>{const b=e.target.closest('.filter-btn');if(!b)return;this.state.filter=b.dataset.filter;this.render();});this.$search.addEventListener('input',(e)=>{this.state.searchTerm=e.target.value.trim();this.render();});this.$btnImport.addEventListener('click',async()=>{const input=document.createElement('input');input.type='file';input.accept='application/json';input.onchange=async()=>{const f=input.files[0];if(!f)return;const text=await f.text();let arr=[];try{arr=JSON.parse(text);}catch{alert('Geen geldige JSON.');return;}const now=Date.now();const normalized=arr.map((raw,i)=>({id:raw.id||`${now}-${i}`,title:raw.title||'Onbekend',type:raw.type||'film',createdAt:raw.createdAt||(now+i),imdbRating:raw.imdbRating||'',year:raw.year||'',runtime:raw.runtime||'',poster:raw.poster||'',streamingOn:raw.streamingOn||'',ourScore:raw.ourScore||'',dateSeen:raw.dateSeen||'',imdbID:raw.imdbID||raw.imdbId||''}));await dbBulkPut(normalized);this.state.items=await dbGetAll();this.render();};input.click();});this.$btnImportCSV.addEventListener('click',async()=>{const input=document.createElement('input');input.type='file';input.accept='.csv,text/csv';input.onchange=async()=>{const file=input.files[0];if(!file)return;Papa.parse(file,{header:true,skipEmptyLines:true,transformHeader:h=>(h||'').toString().trim().toLowerCase(),complete:async(res)=>{const rows=res.data||[];const now=Date.now();const items=rows.map((r,i)=>{const lower={};Object.keys(r).forEach(k=>lower[(k||'').toString().trim().toLowerCase()]=r[k]);const get=k=>lower[k]??'';const imdbConst=(get('const')||'').toString().trim();const title=(get('title')||get('original title')||'').toString().trim()||'Onbekend';const year=(get('year')||'').toString().trim();const runtimeMin=(get('runtime (min)')||get('runtime')||'').toString().trim();const imdbRating=(get('imdb rating')||get('imdb_rating')||'').toString().trim();const yourRating=(get('your rating')||get('your_rating')||'').toString().trim();const dateRated=(get('date rated')||get('date_rated')||'').toString().trim();const platform=(get('description')||get('where')||'').toString().trim();return {id:`${now}-${i}`,title,type:'aan-het-kijken',createdAt:now+i,imdbRating,year,runtime:runtimeMin?(/(min|seizoen|aflever)/i.test(runtimeMin)?runtimeMin:`${runtimeMin} min`):'',poster:'',streamingOn:platform,ourScore:yourRating,dateSeen:dateRated,imdbID:imdbConst};});await dbBulkPut(items);app.state.items=await dbGetAll();app.render();alert(`CSV geïmporteerd: ${items.length} items`);}});};input.click();});this.$btnDemo.addEventListener('click',async()=>{const now=Date.now();const demo=[{id:`d-${now}`,title:'Inception',type:'film',createdAt:now,imdbRating:'8.8',year:'2010',runtime:'148 min',poster:'',streamingOn:'Netflix',ourScore:'9/10',imdbID:'tt1375666'},{id:`d-${now+1}`,title:'Dark',type:'serie',createdAt:now+1,imdbRating:'8.7',year:'2017',runtime:'3 seizoenen',poster:'',streamingOn:'Netflix',ourScore:'8/10',imdbID:'tt5753856'}];await dbBulkPut(demo);this.state.items=await dbGetAll();this.render();});this.$btnFillPosters.addEventListener('click',()=>this.fillPosters());},
async fillPosters(){const key=(localStorage.getItem('omdbKey')||OMDB_DEFAULT_KEY).trim();const items=await dbGetAll();let updated=0,tried=0,hadKeyError=false;for(const item of items){if(item.poster&&item.poster!=='N/A')continue;tried++;try{let url=`https://www.omdbapi.com/?apikey=${encodeURIComponent(key)}&plot=short&r=json`;if(item.imdbID){url+=`&i=${encodeURIComponent(item.imdbID)}`;}else{url+=`&t=${encodeURIComponent(item.title)}${item.year?`&y=${encodeURIComponent(item.year)}`:''}`;}const resp=await fetch(url);const data=await resp.json();if(data&&data.Response==='False'&&String(data.Error||'').toLowerCase().includes('invalid api key')){hadKeyError=true;break;}if(data&&data.Response!=='False'){if(!item.imdbID&&data.imdbID)item.imdbID=data.imdbID;if(data.Poster&&data.Poster!=='N/A'){item.poster=data.Poster;await dbPut(item);updated++;}}await new Promise(r=>setTimeout(r,250));}catch(e){console.warn('OMDb fout',e);}}if(hadKeyError){alert('OMDb: ongeldige API key. Vul je eigen key in en probeer opnieuw.');document.getElementById('omdb-key').classList.remove('hidden');document.getElementById('omdb-key').focus();}else{this.state.items=await dbGetAll();this.render();alert(`Posters aangevuld: ${updated}/${tried}`);}},
filtered(){const term=this.state.searchTerm.toLowerCase();let arr=this.state.items.slice();if(this.state.filter!=='all')arr=arr.filter(i=>i.type===this.state.filter);if(term)arr=arr.filter(i=>(i.title||'').toLowerCase().includes(term));arr.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));return arr;},
render(){const list=this.$list,empty=this.$emptyState;list.innerHTML='';const items=this.filtered();if(items.length===0){empty.classList.remove('hidden');empty.textContent='Geen items.';return;}empty.classList.add('hidden');items.forEach((item,idx)=>{const div=document.createElement('div');div.className='glass-card rounded-xl overflow-hidden shadow';const poster=(item.poster&&item.poster!=='N/A')?item.poster:'https://placehold.co/400x600/e2e8f0/94a3b8?text=Geen+poster';div.innerHTML=`<div class='flex'><div class='w-1/2'><img src='${poster}' class='w-full aspect-[2/3] object-cover'/></div><div class='p-3 w-1/2'><h3 class='font-bold mb-2 text-base'>${item.title}</h3><p class='text-sm'>IMDb: ${item.imdbRating||'N/B'}</p><p class='text-sm'>Jaar: ${item.year||'N/B'}</p><p class='text-sm'>Duur: ${item.runtime||'N/B'}</p><span class='inline-block mt-2 text-xs px-2 py-0.5 rounded bg-sky-100'>${item.type}</span></div></div>`;list.appendChild(div);});}
};
document.addEventListener('DOMContentLoaded',()=>app.init());
</script>
</body>
</html>
