<!doctype html>
<html lang="nl" class="h-full bg-slate-100">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#0f172a"/>
<title>Mijn Films en Series — patch: dedup + poster fallback</title>
<link rel="manifest" href="./manifest.json"/>
<link rel="apple-touch-icon" href="./icons/icon-192.png"/>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  .glass-card{background:rgba(255,255,255,.65);backdrop-filter:saturate(180%) blur(10px)}
  .filter-btn{transition:all .15s ease}
  input,select,button{touch-action:manipulation}
</style>
</head>
<body class="h-full text-slate-900">
<div id="app" class="max-w-6xl mx-auto p-4 pb-24">
  <header class="mb-3 flex items-center justify-between gap-3">
    <h1 class="text-2xl font-bold">Mijn Films en Series</h1>
    <div class="flex gap-2 items-center">
      <button id="btn-import-json" class="px-3 py-2 rounded-xl bg-white/70 hover:bg-white shadow text-sm">Importeer JSON</button>
      <button id="btn-import-csv" class="px-3 py-2 rounded-xl bg-white/70 hover:bg-white shadow text-sm">Importeer CSV (IMDb)</button>
      <button id="btn-add-demo" class="px-3 py-2 rounded-xl bg-indigo-600 text-white shadow text-sm">Demo-items</button>
    </div>
  </header>

  <section class="mb-3">
    <div id="filterControls" class="flex flex-wrap gap-2">
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="film">Films</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="serie">Series</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="herman-film">H-Films</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="herman-serie">H-Series</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="aan-het-kijken">Aan het kijken</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="bekeken">Bekeken</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="all">Alles</button>
      <div class="flex-1"></div>
      <input id="search" type="search" placeholder="Zoeken…" class="px-3 py-2 rounded-lg bg-white/70 shadow w-48"/>
    </div>
  </section>

  <main>
    <div id="list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
    <p id="emptyState" class="hidden text-center text-slate-600 py-10">Laden…</p>
  </main>
</div>

<script>
// --- Simple DB helpers
const DB_NAME='mfs-db', DB_VERSION=1, STORE='items';
function openDB(){return new Promise((resolve,reject)=>{const r=indexedDB.open(DB_NAME,DB_VERSION);r.onupgradeneeded=()=>{const db=r.result;if(!db.objectStoreNames.contains(STORE)){const s=db.createObjectStore(STORE,{keyPath:'id'});s.createIndex('createdAt','createdAt');s.createIndex('type','type');}};r.onsuccess=()=>resolve(r.result);r.onerror=()=>reject(r.error);});}
function tx(db,mode='readonly'){return db.transaction(STORE,mode).objectStore(STORE);}
async function dbGetAll(){const db=await openDB();return new Promise((res,rej)=>{const q=tx(db).getAll();q.onsuccess=()=>res(q.result||[]);q.onerror=()=>rej(q.error);});}
async function dbPut(item){const db=await openDB();return new Promise((res,rej)=>{const p=tx(db,'readwrite').put(item);p.onsuccess=()=>res();p.onerror=()=>rej(p.error);});}
async function dbDelete(id){const db=await openDB();return new Promise((res,rej)=>{const d=tx(db,'readwrite').delete(id);d.onsuccess=()=>res();d.onerror=()=>rej(d.error);});}

// --- Dedup: upsert by (imdbID, type)
async function upsertByImdbType(newItem){
  const all = await dbGetAll();
  const keyID = (newItem.imdbID||'').trim();
  const typ = (newItem.type||'').trim();
  const existing = all.find(it => (it.imdbID||'').trim()===keyID && (it.type||'').trim()===typ);
  if(!existing){
    // brand new
    if(!newItem.id) newItem.id = 'id-'+Date.now()+'-'+Math.random().toString(36).slice(2,7);
    if(!newItem.createdAt) newItem.createdAt = Date.now();
    await dbPut(newItem);
    return 'inserted';
  }
  // merge into existing (prefer non-empty fields)
  const merged = {...existing};
  for(const k of ['title','imdbRating','year','runtime','poster','streamingOn','ourScore','dateSeen','imdbID','type']){
    const nv = (newItem[k]??''); const ov = (existing[k]??'');
    if(!ov && nv) merged[k]=nv;              // fill empty
    if(k==='poster' && nv && nv!=='N/A') merged[k]=nv; // allow poster refresh
  }
  // keep the earliest createdAt
  merged.createdAt = Math.min(existing.createdAt||Date.now(), newItem.createdAt||Date.now());
  merged.id = existing.id; // keep same ID
  await dbPut(merged);
  return 'updated';
}

// --- App
const app={state:{items:[],filter:'all',searchTerm:'',isDbReady:false}};

app.init=async function(){
  this.$list=document.getElementById('list'); this.$empty=document.getElementById('emptyState');
  this.$filters=document.getElementById('filterControls'); this.$search=document.getElementById('search');
  this.$btnImport=document.getElementById('btn-import-json'); this.$btnImportCSV=document.getElementById('btn-import-csv'); this.$btnDemo=document.getElementById('btn-add-demo');

  this.$filters.addEventListener('click',(e)=>{const b=e.target.closest('.filter-btn');if(!b)return;this.state.filter=b.dataset.filter;this.render();});
  this.$search.addEventListener('input',e=>{this.state.searchTerm=e.target.value.trim();this.render();});
  this.$btnImport.addEventListener('click',()=>this.importJSON());
  this.$btnImportCSV.addEventListener('click',()=>this.importCSV());
  this.$btnDemo.addEventListener('click',()=>this.addDemo());

  await openDB(); this.state.isDbReady=true;
  this.state.items=await dbGetAll();
  this.render();
};

// --- Import JSON with dedup
app.importJSON=async function(){
  const i=document.createElement('input'); i.type='file'; i.accept='application/json';
  i.onchange=async ()=>{
    const f=i.files[0]; if(!f) return;
    let arr=[]; try{arr=JSON.parse(await f.text());}catch{alert('Geen geldige JSON');return;}
    let inserted=0, updated=0;
    for(const raw of arr){
      const item={
        id: raw.id, title: raw.title||'Onbekend', type: raw.type||'film',
        createdAt: raw.createdAt||Date.now(),
        imdbRating: raw.imdbRating||'', year: raw.year||'', runtime: raw.runtime||'',
        poster: raw.poster||'', streamingOn: raw.streamingOn||'',
        ourScore: raw.ourScore||'', dateSeen: raw.dateSeen||'',
        imdbID: raw.imdbID||raw.imdbId||''
      };
      const res = await upsertByImdbType(item);
      if(res==='inserted') inserted++; else if(res==='updated') updated++;
    }
    this.state.items=await dbGetAll(); this.render();
    alert(`Import klaar. Nieuw: ${inserted} · Bijgewerkt: ${updated}`);
  };
  i.click();
};

// --- Import CSV with dedup
app.importCSV=async function(){
  const i=document.createElement('input'); i.type='file'; i.accept='.csv,text/csv';
  i.onchange=async ()=>{
    const f=i.files[0]; if(!f) return;
    Papa.parse(f,{header:true,skipEmptyLines:true,transformHeader:h=>(h||'').toString().trim().toLowerCase(),complete:async (res)=>{
      const rows=res.data||[]; let inserted=0, updated=0;
      for(const r of rows){
        const L={}; Object.keys(r).forEach(k=>L[(k||'').toString().trim().toLowerCase()]=r[k]);
        const g=k=>(L[k]??'').toString().trim();
        const item={
          title: (g('title')||g('original title')||'Onbekend'),
          type: 'aan-het-kijken',
          createdAt: Date.now(),
          imdbRating: (g('imdb rating')||g('imdb_rating')||''),
          year: g('year')||'',
          runtime: (()=>{const rt=(g('runtime (min)')||g('runtime')||'');return rt&&/\d/.test(rt)?(rt.includes('min')?rt:`${rt} min`):rt;})(),
          poster: '',
          streamingOn: (g('description')||g('where')||g('platform')||''),
          ourScore: (g('ourscore')||g('onze score')||g('your rating')||g('your_rating')||''),
          dateSeen: (g('dateseen')||g('date seen')||g('date_seen')||g('date rated')||g('date_rated')||''),
          imdbID: (g('const')||g('imdb id')||g('imdbid')||g('imdb_id')||'')
        };
        const res = await upsertByImdbType(item);
        if(res==='inserted') inserted++; else if(res==='updated') updated++;
      }
      app.state.items=await dbGetAll(); app.render();
      alert(`CSV import klaar. Nieuw: ${inserted} · Bijgewerkt: ${updated}`);
    }});
  };
  i.click();
};

// --- Demo
app.addDemo=async function(){
  const now=Date.now();
  const demo=[{id:`d-${now}`, title:'Inception', type:'film', createdAt:now, imdbRating:'8.8', year:'2010', runtime:'148 min', poster:'', streamingOn:'Netflix', ourScore:'9/10', imdbID:'tt1375666'}];
  for(const d of demo){ await upsertByImdbType(d); }
  this.state.items=await dbGetAll(); this.render();
};

// --- UI helpers
app.filtered=function(){
  let arr=this.state.items.slice(); const term=this.state.searchTerm.toLowerCase();
  if(this.state.filter!=='all') arr=arr.filter(i=>i.type===this.state.filter);
  if(term) arr=arr.filter(i=>(i.title||'').toLowerCase().includes(term));
  arr.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)); return arr;
};

app.card=function(item,index){
  const el=document.createElement('div'); el.className='glass-card rounded-xl flex flex-col overflow-hidden shadow-lg text-slate-800';
  const poster=(item.poster&&item.poster!=='N/A')?item.poster:'';
  const tags={film:{c:'bg-sky-200/80 text-sky-900',t:'Film'},serie:{c:'bg-amber-200/80 text-amber-900',t:'Serie'},'herman-film':{c:'bg-purple-200/80 text-purple-900',t:'H-Film'},'herman-serie':{c:'bg-pink-200/80 text-pink-900',t:'H-Serie'},'aan-het-kijken':{c:'bg-blue-200/80 text-blue-900',t:'Aan het kijken'},bekeken:{c:'bg-green-200/80 text-green-900',t:'Bekeken'}};
  const tag=tags[item.type]||{c:'bg-slate-200/80 text-slate-900',t:item.type};
  el.innerHTML=`<div class="flex">
    <div class="w-1/2 flex-shrink-0 relative">
      <div class="aspect-[2/3] w-full">
        <img src="${poster||(`https://img.omdbapi.com/?i=${encodeURIComponent(item.imdbID||'')}&apikey=8a70a767`)}"
             referrerpolicy="no-referrer"
             data-imdb="${item.imdbID||''}"
             onerror="if(this.dataset.retry!=='1' && this.dataset.imdb){ this.dataset.retry='1'; this.src='https://img.omdbapi.com/?i='+this.dataset.imdb+'&apikey=8a70a767'; } else { this.onerror=null; this.src='https://placehold.co/400x600/e2e8f0/94a3b8?text=Fout'; }"
             alt="Poster van ${item.title}" class="w-full h-full object-cover">
      </div>
      <div class="absolute top-2 left-2 bg-black/70 text-white w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm">${index}</div>
    </div>
    <div class="p-3 flex flex-col flex-grow w-1/2">
      <h3 class="font-bold text-base leading-tight mb-2">${item.title}</h3>
      <div class="text-sm text-slate-700 space-y-0.5 mb-2"><p><strong>IMDB:</strong> ${item.imdbRating||'N/B'}</p><p><strong>Jaar:</strong> ${item.year||'N/B'}</p><p><strong>Duur:</strong> ${item.runtime||'N/B'}</p></div>
      <div class="mb-2 flex justify-between items-center"><span class="text-xs font-semibold px-2 py-0.5 rounded-full ${tag.c}">${tag.t}</span>
        <button data-id="${item.id}" data-action="delete" title="Verwijderen" class="bg-white/50 text-slate-600 hover:bg-red-500 hover:text-white w-7 h-7 flex items-center justify-center rounded-full transition-all">
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="flex flex-col gap-2 mt-1">
        <input type="text" data-id="${item.id}" value="${item.ourScore||''}" class="our-score-input w-full p-1.5 border border-slate-300/50 rounded-md text-xs" placeholder="Onze score">
        <button data-id="${item.id}" data-imdbid="${item.imdbID||''}" data-action="show-imdb" class="w-full bg-yellow-400/80 text-yellow-900 hover:bg-yellow-400 font-semibold py-1.5 px-2 rounded-md text-xs">IMDB Info</button>
      </div>
    </div>
  </div>`;
  const tail = document.createElement('div');
  tail.className = 'p-3 pt-2 text-xs space-y-2 border-t border-white/20';
  tail.innerHTML = `<div class="grid grid-cols-2 gap-2">
    <div><label class="block font-medium text-slate-600 mb-0.5">Categorie</label>
      <select data-id="${item.id}" class="category-select w-full p-1.5 border border-slate-300/50 rounded-md">
        ${Object.entries(tags).map(([k,v])=>`<option value="${k}" ${item.type===k?'selected':''}>${v.t}</option>`).join('')}
      </select>
    </div>
    <div><label class="block font-medium text-slate-600 mb-0.5">Waar te bekijken</label>
      <select data-id="${item.id}" class="streaming-service-select w-full p-1.5 border border-slate-300/50 rounded-md">
        ${['','Netflix','Disney+','Prime Video','Apple TV+','VRT MAX','Play','Streamz','Videoland','Blu-ray','iTunes'].map(o=>`<option value="${o}" ${item.streamingOn===o?'selected':''}>${o}</option>`).join('')}
      </select>
    </div>
  </div>` + (item.type==='bekeken'?`<div><label class="block font-medium text-slate-600 mb-0.5">Laatst gezien op</label><input type="date" data-id="${item.id}" value="${item.dateSeen||''}" class="date-seen-input w-full p-1.5 border border-slate-300/50 rounded-md"></div>`:'');
  el.appendChild(tail);
  return el;
};

document.addEventListener('click', async e=>{
  const del=e.target.closest('[data-action="delete"]'); if(del){ await dbDelete(del.dataset.id); app.state.items=await dbGetAll(); app.render(); }
  const imdb=e.target.closest('[data-action="show-imdb"]'); if(imdb){ const id=imdb.dataset.imdbid; if(id) window.open('https://www.imdb.com/title/'+id,'_blank'); }
});
document.addEventListener('change', async e=>{
  const id=e.target.getAttribute('data-id'); if(!id) return;
  const items=await dbGetAll(); const it=items.find(x=>x.id==id); if(!it) return;
  if(e.target.classList.contains('category-select')) it.type=e.target.value;
  if(e.target.classList.contains('streaming-service-select')) it.streamingOn=e.target.value;
  if(e.target.classList.contains('our-score-input')) it.ourScore=e.target.value;
  if(e.target.classList.contains('date-seen-input')) it.dateSeen=e.target.value;
  await dbPut(it); app.state.items=await dbGetAll(); app.render();
});

app.render=async function(){
  const list=this.$list, empty=this.$empty; list.innerHTML='';
  document.querySelectorAll('#filterControls .filter-btn').forEach(btn=>{
    const active=(btn.dataset.filter===this.state.filter);
    btn.classList.toggle('bg-indigo-600',active); btn.classList.toggle('text-white',active);
    btn.classList.toggle('bg-white/50',!active); btn.classList.toggle('text-slate-800',!active);
  });
  const items=this.filtered(); if(items.length===0){ empty.textContent=(await dbGetAll()).length?'Geen items in deze filter.':'Je lijst is leeg.'; empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden'); items.forEach((it,idx)=> list.appendChild(this.card(it, idx+1)));
};

document.addEventListener('DOMContentLoaded',()=>app.init());
</script>
</body>
</html>
