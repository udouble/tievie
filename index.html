<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tievie</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and smooth transitions */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Fallback */
            background-image: radial-gradient(circle at 10% 20%, rgb(0, 119, 182, 0.8) 0%, rgb(251, 133, 0, 0.6) 90%);
            min-height: 100vh;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        /* Glassmorphism Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-glass {
             background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        /* Styling for the loading spinner */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // Expose functions to the global scope so our app script can use them
        window.firebase = {
            initializeApp,
            getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, writeBatch, getDocs,
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged
        };
    </script>
</head>
<body class=" text-slate-800">

    <!-- Main Container -->
    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8 flex flex-col sm:flex-row items-center justify-center gap-4">
            <div class="flex items-center gap-3">
                <svg class="h-12 w-12 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2Z" fill="url(#paint0_linear_1_2)"/><path d="M15.5 10.5L10.5 15.5L8.5 13.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><defs><linearGradient id="paint0_linear_1_2" x1="2" y1="2" x2="22" y2="22" gradientUnits="userSpaceOnUse"><stop stop-color="#FB8500"/><stop offset="1" stop-color="#0077B6"/></linearGradient></defs></svg>
                <h1 class="text-5xl font-bold text-white tracking-tight" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">Tievie</h1>
            </div>
            <p class="text-white/80 sm:border-l-2 sm:pl-4 sm:ml-4 border-white/30">Uw persoonlijke film- en seriegids</p>
        </header>

        <!-- Search Controls -->
        <div class="glass-card p-6 rounded-2xl shadow-lg mb-8 max-w-4xl mx-auto">
            <div class="flex flex-col md:flex-row gap-4 md:gap-6">
                <div class="relative flex-grow">
                    <input type="text" id="item-input" placeholder="Zoek een titel om toe te voegen..." autocomplete="off" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none transition-all">
                    <div id="suggestions-container" class="absolute z-30 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg hidden max-h-96 overflow-y-auto"></div>
                </div>
                <div class="relative flex-grow">
                    <input type="text" id="search-input" placeholder="Zoek in uw lijsten..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none transition-all">
                </div>
            </div>
        </div>
        
        <!-- Filter Controls, Randomizer & Sort -->
        <div class="glass-card p-4 rounded-2xl max-w-6xl mx-auto mb-8">
            <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                <div class="flex justify-center items-center gap-2 flex-wrap" id="filter-controls">
                     <button data-filter="all" class="filter-btn active bg-indigo-600 text-white font-semibold px-4 py-2 rounded-full text-sm transition-all">Alles</button>
                     <button data-filter="film" class="filter-btn bg-white/50 text-slate-800 font-semibold px-4 py-2 rounded-full text-sm transition-all hover:bg-white/80">Films</button>
                     <button data-filter="serie" class="filter-btn bg-white/50 text-slate-800 font-semibold px-4 py-2 rounded-full text-sm transition-all hover:bg-white/80">Series</button>
                     <button data-filter="aan-het-kijken" class="filter-btn bg-white/50 text-slate-800 font-semibold px-4 py-2 rounded-full text-sm transition-all hover:bg-white/80">Aan het kijken</button>
                     <button data-filter="herman-film" class="filter-btn bg-white/50 text-slate-800 font-semibold px-4 py-2 rounded-full text-sm transition-all hover:bg-white/80">H-Film</button>
                     <button data-filter="herman-serie" class="filter-btn bg-white/50 text-slate-800 font-semibold px-4 py-2 rounded-full text-sm transition-all hover:bg-white/80">H-Serie</button>
                     <button data-filter="bekeken" class="filter-btn bg-white/50 text-slate-800 font-semibold px-4 py-2 rounded-full text-sm transition-all hover:bg-white/80">Bekeken</button>
                </div>
                
                <div class="flex items-center gap-2 flex-wrap justify-center">
                    <div id="randomizer-container" class="hidden">
                         <button id="random-btn" title="Kies een willekeurige titel" class="flex items-center gap-2 bg-white/80 text-slate-800 font-semibold px-3 py-2 rounded-full text-sm transition-all hover:bg-white border border-slate-300">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5a.75.75 0 01.75.75v.313c0 .324.238.604.557.712a10.461 10.461 0 014.223 2.506c.21.18.496.222.753.107a.75.75 0 01.884 1.152 11.96 11.96 0 00-3.1 3.868c-.12.256-.07.567.123.758a10.461 10.461 0 012.506 4.223c.108.32.388.557.712.557h.313a.75.75 0 010 1.5h-.313c-.324 0-.604.238-.712.557a10.461 10.461 0 01-2.506 4.223c-.18.21-.222.496-.107.753a.75.75 0 01-1.152.884 11.96 11.96 0 00-3.868-3.1c-.256-.12-.567-.07-.758.123a10.461 10.461 0 01-4.223 2.506c-.32.108-.557.388-.557.712v.313a.75.75 0 01-1.5 0v-.313c0-.324-.238-.604-.557-.712a10.461 10.461 0 01-4.223-2.506c-.21-.18-.496-.222-.753-.107a.75.75 0 01-.884-1.152 11.96 11.96 0 003.1-3.868c.12-.256.07-.567-.123-.758a10.461 10.461 0 01-2.506-4.223c-.108-.32-.388-.557-.712-.557H3a.75.75 0 010-1.5h.313c.324 0 .604-.238.712-.557a10.461 10.461 0 012.506-4.223c.18-.21.222-.496.107-.753a.75.75 0 011.152-.884 11.96 11.96 0 003.868 3.1c.256.12.567.07.758-.123a10.461 10.461 0 014.223-2.506c.32-.108.557-.388.557-.712V3.25a.75.75 0 01.75-.75zM12 9a3 3 0 100 6 3 3 0 000-6z" /></svg>
                            <span id="random-btn-text">Kies</span>
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="sort-by" class="p-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:outline-none">
                            <option value="default">Sorteer: Nieuwste</option>
                            <option value="title-asc">Sorteer: Titel</option>
                            <option value="imdb-desc">Sorteer: IMDb Score</option>
                            <option value="ourscore-desc">Sorteer: Onze Score</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Random Item View -->
        <div id="random-view-container" class="text-center hidden mb-8">
            <button id="show-full-list-btn" class="bg-amber-500 text-white font-semibold px-6 py-3 rounded-lg hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-all shadow">
                Toon volledige lijst
            </button>
        </div>

        <!-- Item Grid -->
        <div id="item-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Items will be dynamically inserted here -->
        </div>
        
        <p id="empty-state" class="text-center text-white/80 py-10 hidden col-span-full">Verbinden met de database...</p>

    </div>
    
    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-30 hidden z-40"></div>

    <div id="add-details-modal" class="modal-glass fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-8 max-w-lg w-full rounded-2xl shadow-2xl hidden transition-all z-50">
        <h2 class="text-2xl font-bold mb-2">Details Toevoegen</h2>
        <p id="modal-item-title" class="font-semibold text-lg text-slate-700 mb-6"></p>
        <div class="space-y-4">
            <div>
                <label for="modal-type-select" class="block text-sm font-medium text-slate-700 mb-1">Categorie</label>
                <select id="modal-type-select" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none transition-all">
                    <option value="film">Films</option>
                    <option value="serie">Series</option>
                    <option value="aan-het-kijken">Aan het kijken</option>
                    <option value="herman-film">H-Film</option>
                    <option value="herman-serie">H-Serie</option>
                    <option value="bekeken">Bekeken</option>
                </select>
            </div>
            <div>
                <label for="modal-streaming-select" class="block text-sm font-medium text-slate-700 mb-1">Waar te bekijken</label>
                <select id="modal-streaming-select" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none transition-all">
                </select>
            </div>
        </div>
        <div class="flex justify-end gap-4 mt-8">
            <button id="cancel-add-btn" class="bg-slate-200 text-slate-800 font-semibold px-6 py-3 rounded-lg hover:bg-slate-300 transition-all">Annuleren</button>
            <button id="confirm-add-btn" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 transition-all">Definitief Toevoegen</button>
        </div>
    </div>
    
    <div id="imdb-info-modal" class="modal-glass fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-8 max-w-2xl w-full rounded-2xl shadow-2xl hidden transition-all z-50 max-h-[80vh] overflow-y-auto">
        <!-- Content will be injected here -->
    </div>

    <div id="delete-modal" class="modal-glass fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-8 max-w-sm w-full rounded-2xl shadow-2xl text-center hidden transition-all z-50">
        <h2 class="text-2xl font-bold mb-4">Weet je het zeker?</h2>
        <p class="text-slate-600 mb-8">Dit item wordt permanent verwijderd.</p>
        <div class="flex justify-center gap-4">
            <button id="cancel-delete" class="bg-slate-200 text-slate-800 font-semibold px-6 py-3 rounded-lg hover:bg-slate-300 transition-all">Annuleren</button>
            <button id="confirm-delete" class="bg-red-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-red-700 transition-all">Verwijderen</button>
        </div>
    </div>

    <script>
        const app = {
            // Application State
            state: {
                items: [],
                filter: 'all',
                sortBy: 'default',
                searchTerm: '',
                randomlySelectedItem: null,
                itemToDelete: null,
                apiKey: '8a70a767',
                appId: null,
                searchTimeout: null,
                selectedItemForAddition: null,
                db: null,
                auth: null,
                userId: null,
                isDbReady: false,
            },

            // DOM Elements
            elements: {},

            // Initialization
            async init() {
                this.bindElements();
                this.populateStreamingSelects();
                this.loadAppId();
                this.attachEventListeners();
                await this.initFirebase();
            },
            
            bindElements() {
                this.elements = {
                    input: document.getElementById('item-input'),
                    searchInput: document.getElementById('search-input'),
                    list: document.getElementById('item-list'),
                    emptyState: document.getElementById('empty-state'),
                    filterControls: document.getElementById('filter-controls'),
                    sortBySelect: document.getElementById('sort-by'),
                    modalBackdrop: document.getElementById('modal-backdrop'),
                    addDetailsModal: document.getElementById('add-details-modal'),
                    modalItemTitle: document.getElementById('modal-item-title'),
                    modalTypeSelect: document.getElementById('modal-type-select'),
                    modalStreamingSelect: document.getElementById('modal-streaming-select'),
                    confirmAddBtn: document.getElementById('confirm-add-btn'),
                    cancelAddBtn: document.getElementById('cancel-add-btn'),
                    imdbInfoModal: document.getElementById('imdb-info-modal'),
                    deleteModal: document.getElementById('delete-modal'),
                    confirmDeleteBtn: document.getElementById('confirm-delete'),
                    cancelDeleteBtn: document.getElementById('cancel-delete'),
                    suggestionsContainer: document.getElementById('suggestions-container'),
                    randomBtn: document.getElementById('random-btn'),
                    randomBtnText: document.getElementById('random-btn-text'),
                    randomizerContainer: document.getElementById('randomizer-container'),
                    randomViewContainer: document.getElementById('random-view-container'),
                    showFullListBtn: document.getElementById('show-full-list-btn'),
                }
            },
            
            getStreamingOptions() {
                return ['Niet gespecificeerd', 'Apple TV+', 'Disney+', 'GoPlay', 'HBO Max', 'Netflix', 'Prime Video', 'Streamz', 'VTM GO', 'VRT MAX', 'Anders...'];
            },
            
            populateStreamingSelects() {
                const optionsHTML = this.getStreamingOptions().map(opt => `<option value="${opt}">${opt}</option>`).join('');
                this.elements.modalStreamingSelect.innerHTML = optionsHTML;
            },

            loadAppId() {
                const permanentRecoveryId = 'c_cc0e5ff79b33a80f_index.html-763';
                this.state.appId = permanentRecoveryId; 
            },

            async initFirebase() {
                try {
                    const { initializeApp, getFirestore, getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } = window.firebase;
                    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    
                    if (!firebaseConfig.apiKey) throw new Error("Firebase config niet gevonden.");

                    const firebaseApp = initializeApp(firebaseConfig);
                    this.state.db = getFirestore(firebaseApp);
                    this.state.auth = getAuth(firebaseApp);

                    onAuthStateChanged(this.state.auth, async (user) => {
                        if (user) {
                            this.state.userId = user.uid;
                            this.state.isDbReady = true;
                            await this.fetchAndRenderItems(); 
                        } else {
                            this.state.isDbReady = false;
                            this.state.userId = null;
                        }
                    });

                    if (initialAuthToken) {
                        await signInWithCustomToken(this.state.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(this.state.auth);
                    }
                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                }
            },
            
            async fetchAndRenderItems() {
                 if (!this.state.isDbReady) return;
                
                this.elements.emptyState.textContent = "Lijst wordt geladen...";
                this.elements.emptyState.classList.remove('hidden');
                this.elements.list.innerHTML = '';
                
                try {
                    const itemsCollectionRef = window.firebase.collection(this.state.db, `/artifacts/${this.state.appId}/users/${this.state.userId}/items`);
                    const querySnapshot = await window.firebase.getDocs(itemsCollectionRef);
                    
                    let items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ ...doc.data(), id: doc.id });
                    });
                    
                    this.state.items = items;
                    this.render();
                } catch (error) {
                    console.error("Error during data fetch:", error);
                }
            },

            attachEventListeners() {
                this.elements.input.addEventListener('input', (e) => {
                    clearTimeout(this.state.searchTimeout);
                    this.state.selectedItemForAddition = null; 
                    this.state.searchTimeout = setTimeout(() => this.searchOMDb(e.target.value), 300); 
                });

                this.elements.searchInput.addEventListener('input', (e) => this.setSearchTerm(e.target.value));
                
                document.addEventListener('click', (e) => {
                    if (!this.elements.suggestionsContainer.contains(e.target)) this.clearSuggestions();
                });

                this.elements.list.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;

                    const id = button.dataset.id;
                    if (button.dataset.action === 'delete') this.openDeleteModal(id);
                    if (button.dataset.action === 'show-imdb') this.openImdbModal(button.dataset.imdbid);
                });

                this.elements.list.addEventListener('change', (e) => {
                    const target = e.target;
                    const id = target.dataset.id;
                    if (target.matches('.our-score-input')) this.updateItemField(id, 'ourScore', target.value);
                    if (target.matches('.date-seen-input')) this.updateItemField(id, 'dateSeen', target.value);
                    if (target.matches('.streaming-service-select')) this.updateItemField(id, 'streamingOn', target.value);
                    if (target.matches('.category-select')) this.updateItemField(id, 'type', target.value);
                });
                
                this.elements.filterControls.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (target && target.dataset.filter) this.setFilter(target.dataset.filter);
                });
                
                this.elements.sortBySelect.addEventListener('change', (e) => this.setSortBy(e.target.value));
                this.elements.randomBtn.addEventListener('click', () => this.selectRandomItem());
                this.elements.showFullListBtn.addEventListener('click', () => this.clearRandomSelection());
                
                this.elements.confirmDeleteBtn.addEventListener('click', () => this.confirmDelete());
                this.elements.cancelDeleteBtn.addEventListener('click', () => this.closeDeleteModal());
                
                this.elements.confirmAddBtn.addEventListener('click', async () => await this.addItem());
                this.elements.cancelAddBtn.addEventListener('click', () => this.closeAddDetailsModal());

                this.elements.modalBackdrop.addEventListener('click', () => {
                    this.closeAddDetailsModal();
                    this.closeDeleteModal();
                    this.closeImdbModal();
                });
            },
            
            async searchOMDb(query) {
                if (query.trim().length < 3) {
                    this.clearSuggestions();
                    return;
                }
                
                this.elements.suggestionsContainer.innerHTML = `<div class="flex justify-center items-center p-4"><div class="loader"></div></div>`;
                this.elements.suggestionsContainer.classList.remove('hidden');

                try {
                    const searchQuery = `${query.trim()}*`;
                    const listResponse = await fetch(`https://www.omdbapi.com/?s=${encodeURIComponent(searchQuery)}&apikey=${this.state.apiKey}`);
                    const listData = await listResponse.json();
                    
                    if (listData.Response === "True" && listData.Search) {
                        const detailedPromises = listData.Search.slice(0, 5).map(item => 
                            fetch(`https://www.omdbapi.com/?i=${item.imdbID}&apikey=${this.state.apiKey}`).then(res => res.json())
                        );
                        const detailedResults = await Promise.all(detailedPromises);
                        this.renderSuggestions(detailedResults);
                    } else {
                         this.elements.suggestionsContainer.innerHTML = `<div class="p-3 text-slate-500">Geen resultaten gevonden.</div>`;
                    }
                } catch (error) {
                    console.error("Error fetching from OMDb:", error);
                    this.elements.suggestionsContainer.innerHTML = `<div class="p-3 text-red-500">Kon geen verbinding maken.</div>`;
                }
            },

            renderSuggestions(suggestions) {
                this.clearSuggestions();
                 if (suggestions.length === 0) {
                    this.elements.suggestionsContainer.innerHTML = `<div class="p-3 text-slate-500">Geen resultaten gevonden.</div>`;
                    this.elements.suggestionsContainer.classList.remove('hidden');
                    return;
                }

                suggestions.forEach(item => {
                    if (!item || item.Response !== "True") return; 

                    const suggestionEl = document.createElement('div');
                    suggestionEl.className = 'p-3 hover:bg-orange-100 cursor-pointer border-b border-slate-100 last:border-b-0 flex gap-4 items-center';
                    
                    const posterSrc = item.Poster !== 'N/A' ? item.Poster : 'https://placehold.co/60x90/e2e8f0/94a3b8?text=Geen+poster';
                    const typeText = item.Type === 'movie' ? 'Film' : (item.Type === 'series' ? 'Serie' : item.Type);

                    suggestionEl.innerHTML = `
                        <img src="${posterSrc}" alt="Poster" class="w-[60px] h-[90px] object-cover rounded-md flex-shrink-0 bg-slate-200" onerror="this.onerror=null;this.src='https://placehold.co/60x90/e2e8f0/94a3b8?text=Fout';">
                        <div class="overflow-hidden">
                            <p class="font-bold text-slate-800 truncate">${item.Title}</p>
                            <div class="text-sm text-slate-500 mt-1 flex flex-wrap gap-x-3 gap-y-1">
                                <span>⭐ ${item.imdbRating || 'N/B'}</span>
                                <span>${typeText}</span>
                                <span>${item.Year || 'N/B'}</span>
                                <span>${item.Runtime || 'N/B'}</span>
                            </div>
                        </div>
                    `;
                    
                    suggestionEl.addEventListener('click', () => {
                        this.openAddDetailsModal(item);
                    });
                    this.elements.suggestionsContainer.appendChild(suggestionEl);
                });
                this.elements.suggestionsContainer.classList.remove('hidden');
            },

            clearSuggestions() {
                this.elements.suggestionsContainer.innerHTML = '';
                this.elements.suggestionsContainer.classList.add('hidden');
            },
            
            openAddDetailsModal(item) {
                this.state.selectedItemForAddition = item;
                this.elements.modalItemTitle.textContent = item.Title;
                this.elements.addDetailsModal.classList.remove('hidden');
                this.elements.modalBackdrop.classList.remove('hidden');
                this.clearSuggestions();
            },
            
            closeAddDetailsModal() {
                this.state.selectedItemForAddition = null;
                this.elements.addDetailsModal.classList.add('hidden');
                this.elements.modalBackdrop.classList.add('hidden');
                this.elements.input.value = '';
            },

            async addItem() {
                 if (!this.state.isDbReady || !this.state.selectedItemForAddition) return;
                
                const item = this.state.selectedItemForAddition;
                const type = this.elements.modalTypeSelect.value;
                const streamingOn = this.elements.modalStreamingSelect.value;
                
                const newItemData = {
                    imdbID: item.imdbID || null,
                    title: item.Title,
                    type: type,
                    poster: item.Poster,
                    imdbRating: item.imdbRating,
                    year: item.Year,
                    runtime: item.Runtime,
                    ourScore: '',
                    dateSeen: '',
                    streamingOn: streamingOn,
                    createdAt: Date.now()
                };
                
                const alreadyExists = this.state.items.some(i => i.imdbID && i.imdbID === newItemData.imdbID);
                if (newItemData.imdbID && alreadyExists) {
                    this.closeAddDetailsModal();
                    return;
                }
                
                const itemsCollection = window.firebase.collection(this.state.db, `/artifacts/${this.state.appId}/users/${this.state.userId}/items`);
                await window.firebase.addDoc(itemsCollection, newItemData);

                this.closeAddDetailsModal();
                await this.fetchAndRenderItems();
            },

            async updateItemField(id, field, value) {
                if (!this.state.isDbReady) return;
                const itemRef = window.firebase.doc(this.state.db, `/artifacts/${this.state.appId}/users/${this.state.userId}/items`, id);
                await window.firebase.updateDoc(itemRef, { [field]: value });
                
                const item = this.state.items.find(i => i.id === id);
                if (item) item[field] = value;
                
                if (field === 'type') {
                    await this.fetchAndRenderItems();
                }
            },
            
            async deleteItem(id) {
                if (!this.state.isDbReady) return;
                const itemRef = window.firebase.doc(this.state.db, `/artifacts/${this.state.appId}/users/${this.state.userId}/items`, id);
                await window.firebase.deleteDoc(itemRef);
                await this.fetchAndRenderItems();
            },

            setFilter(filterValue) {
                this.state.randomlySelectedItem = null;
                this.state.filter = filterValue;
                this.elements.searchInput.value = '';
                this.state.searchTerm = '';
                this.render();
            },
            
            setSearchTerm(term) {
                this.state.searchTerm = term.trim();
                this.render();
            },

            setSortBy(sortByValue) {
                this.state.sortBy = sortByValue;
                this.render();
            },
            
            clearRandomSelection() {
                this.state.randomlySelectedItem = null;
                this.render();
            },

            selectRandomItem() {
                const category = this.state.filter;
                const categoryItems = this.state.items.filter(item => item.type === category);
                if (categoryItems.length === 0) return;
                const randomIndex = Math.floor(Math.random() * categoryItems.length);
                this.state.randomlySelectedItem = categoryItems[randomIndex];
                this.render();
            },

            openDeleteModal(id) {
                this.state.itemToDelete = id;
                this.elements.deleteModal.classList.remove('hidden');
                this.elements.modalBackdrop.classList.remove('hidden');
            },

            closeDeleteModal() {
                this.state.itemToDelete = null;
                this.elements.deleteModal.classList.add('hidden');
                this.elements.modalBackdrop.classList.add('hidden');
            },

            async confirmDelete() {
                if (this.state.itemToDelete) {
                    await this.deleteItem(this.state.itemToDelete);
                }
                this.closeDeleteModal();
            },
            
            async openImdbModal(imdbID) {
                if (!imdbID) return;
                this.elements.imdbInfoModal.innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div></div>';
                this.elements.imdbInfoModal.classList.remove('hidden');
                this.elements.modalBackdrop.classList.remove('hidden');

                try {
                    const response = await fetch(`https://www.omdbapi.com/?i=${imdbID}&plot=full&apikey=${this.state.apiKey}`);
                    const data = await response.json();
                    
                    if (data.Response === "True") {
                         this.elements.imdbInfoModal.innerHTML = `
                            <button id="close-imdb-modal" class="absolute top-4 right-4 text-slate-600 hover:text-slate-900">
                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                            <h2 class="text-2xl font-bold mb-4">${data.Title} (${data.Year})</h2>
                            <p class="mb-4 text-slate-600">${data.Plot}</p>
                            <p><strong>Acteurs:</strong> ${data.Actors}</p>
                            <p><strong>Regisseur:</strong> ${data.Director}</p>
                            <p><strong>Genre:</strong> ${data.Genre}</p>
                            <p><strong>Score:</strong> ⭐ ${data.imdbRating}</p>
                         `;
                         document.getElementById('close-imdb-modal').addEventListener('click', () => this.closeImdbModal());
                    } else {
                        this.elements.imdbInfoModal.innerHTML = `<p class="text-red-500">Kon details niet ophalen.</p>`;
                    }
                } catch(e) {
                    this.elements.imdbInfoModal.innerHTML = `<p class="text-red-500">Fout bij het ophalen van informatie.</p>`;
                }
            },

            closeImdbModal() {
                this.elements.imdbInfoModal.classList.add('hidden');
                this.elements.modalBackdrop.classList.add('hidden');
            },

            render() {
                const { list, emptyState, filterControls, randomBtn, randomBtnText, randomizerContainer, randomViewContainer } = this.elements;
                list.innerHTML = '';
                
                let itemsToDisplay;

                if (this.state.randomlySelectedItem) {
                    itemsToDisplay = [this.state.randomlySelectedItem];
                    randomViewContainer.classList.remove('hidden');
                } else {
                    randomViewContainer.classList.add('hidden');
                    let baseList = this.state.items;
                    
                    if (this.state.searchTerm) {
                        const searchTermLower = this.state.searchTerm.toLowerCase();
                        baseList = this.state.items.filter(item => item.title.toLowerCase().includes(searchTermLower));
                    }

                    itemsToDisplay = baseList.filter(item => {
                        if (this.state.searchTerm) return true; 
                        if (this.state.filter === 'all') return true;
                        return item.type === this.state.filter;
                    });
                    
                    switch (this.state.sortBy) {
                        case 'title-asc':
                            itemsToDisplay.sort((a, b) => a.title.localeCompare(b.title));
                            break;
                        case 'imdb-desc':
                            itemsToDisplay.sort((a, b) => (parseFloat(b.imdbRating) || 0) - (parseFloat(a.imdbRating) || 0));
                            break;
                        case 'ourscore-desc':
                            itemsToDisplay.sort((a, b) => (parseFloat(b.ourScore) || 0) - (parseFloat(a.ourScore) || 0));
                            break;
                        default:
                             itemsToDisplay.sort((a, b) => b.createdAt - a.createdAt);
                            break;
                    }
                }
                
                filterControls.querySelectorAll('.filter-btn').forEach(btn => {
                    const isActive = this.state.searchTerm ? false : (btn.dataset.filter === this.state.filter && !this.state.randomlySelectedItem);
                    btn.classList.toggle('active', isActive);
                    btn.classList.toggle('bg-indigo-600', isActive);
                    btn.classList.toggle('text-white', isActive);
                    btn.classList.toggle('bg-white/50', !isActive);
                    btn.classList.toggle('text-slate-800', !isActive);
                });
                
                const randomizableCategories = ['film', 'serie', 'herman-film', 'herman-serie'];
                const showRandomizer = randomizableCategories.includes(this.state.filter);
                randomizerContainer.classList.toggle('hidden', !showRandomizer || this.state.randomlySelectedItem);
                if(showRandomizer) {
                    const textMap = {'film': 'Film', 'serie': 'Serie', 'herman-film': 'H-Film', 'herman-serie': 'H-Serie'};
                    randomBtnText.textContent = textMap[this.state.filter];
                }


                if (itemsToDisplay.length === 0) {
                    list.appendChild(emptyState);
                    if (!this.state.isDbReady) {
                         emptyState.textContent = 'Verbinden met de database...';
                    } else if (this.state.items.length === 0) {
                        emptyState.textContent = 'Je lijst is leeg.';
                    } else {
                         if(this.state.searchTerm) {
                            emptyState.textContent = `Geen resultaten gevonden voor "${this.state.searchTerm}".`;
                         } else {
                            const filterTextMap = { 
                                film: 'films', serie: 'series', 'aan-het-kijken': 'items die je aan het kijken bent',
                                'herman-film': 'H-Films', 'herman-serie': 'H-Series', bekeken: 'bekeken items',
                            };
                            emptyState.textContent = `Geen ${filterTextMap[this.state.filter] || 'items'} gevonden.`;
                         }
                    }
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    itemsToDisplay.forEach((item, index) => {
                        const itemElement = this.createItemElement(item, index + 1);
                        list.appendChild(itemElement);
                    });
                }
            },

            createItemElement(item, index) {
                const div = document.createElement('div');
                div.className = `glass-card rounded-xl flex flex-col overflow-hidden shadow-lg text-slate-800`;
                div.dataset.itemId = item.id;
                const posterSrc = (item.poster && item.poster !== 'N/A') ? item.poster : 'https://placehold.co/400x600/e2e8f0/94a3b8?text=Geen+poster';
                
                const tagConfig = {
                    film: { color: 'bg-sky-200/80 text-sky-900', text: 'Film' }, 
                    serie: { color: 'bg-amber-200/80 text-amber-900', text: 'Serie' },
                    'herman-film': { color: 'bg-purple-200/80 text-purple-900', text: 'H-Film' }, 
                    'herman-serie': { color: 'bg-pink-200/80 text-pink-900', text: 'H-Serie' },
                    'aan-het-kijken': { color: 'bg-blue-200/80 text-blue-900', text: 'Aan het kijken' }, 
                    bekeken: { color: 'bg-green-200/80 text-green-900', text: 'Bekeken' },
                };
                const tag = tagConfig[item.type] || { color: 'bg-slate-200/80 text-slate-900', text: item.type };
                
                const streamingOptionsHTML = this.getStreamingOptions().map(opt => `<option value="${opt}" ${item.streamingOn === opt ? 'selected' : ''}>${opt}</option>`).join('');
                const categoryOptionsHTML = Object.keys(tagConfig).map(key => `<option value="${key}" ${item.type === key ? 'selected' : ''}>${tagConfig[key].text}</option>`).join('');
                
                let dateSeenHTML = '';
                if (item.type === 'bekeken') {
                    dateSeenHTML = `
                        <div class="mt-2">
                            <label class="block text-xs font-medium text-slate-600 mb-0.5">Laatst gezien op</label>
                            <input type="date" data-id="${item.id}" value="${item.dateSeen || ''}" class="date-seen-input w-full p-1.5 border border-slate-300/50 rounded-md">
                        </div>`;
                }

                div.innerHTML = `
                    <div class="flex border-b border-white/20">
                        <div class="w-1/2 flex-shrink-0 relative">
                            <div class="aspect-[2/3] w-full">
                                <img src="${posterSrc}" alt="Poster van ${item.title}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x600/e2e8f0/94a3b8?text=Fout';">
                            </div>
                            <div class="absolute top-2 left-2 bg-black bg-opacity-70 text-white w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm">${index}</div>
                        </div>
                        <div class="p-3 flex flex-col flex-grow w-1/2">
                            <h3 class="font-bold text-base leading-tight mb-2">${item.title}</h3>
                            <div class="text-sm text-slate-700 space-y-0.5 mb-3">
                                <p><strong>IMDB:</strong> ${item.imdbRating || 'N/B'}</p>
                                <p><strong>Jaar:</strong> ${item.year || 'N/B'}</p>
                                <p><strong>Duur:</strong> ${item.runtime || 'N/B'}</p>
                            </div>
                             <div class="mb-3 flex justify-between items-center">
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${tag.color}">${tag.text}</span>
                                <button data-id="${item.id}" data-action="delete" title="Verwijderen" class="bg-white/50 text-slate-600 hover:bg-red-500 hover:text-white w-7 h-7 flex items-center justify-center rounded-full transition-all">
                                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 pt-2 text-xs space-y-2">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block font-medium text-slate-600 mb-0.5">Categorie</label>
                                <select data-id="${item.id}" class="category-select w-full p-1.5 border border-slate-300/50 rounded-md">
                                    ${categoryOptionsHTML}
                                </select>
                            </div>
                            <div>
                                <label class="block font-medium text-slate-600 mb-0.5">Waar te bekijken</label>
                                <select data-id="${item.id}" class="streaming-service-select w-full p-1.5 border border-slate-300/50 rounded-md">
                                   ${streamingOptionsHTML}
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block font-medium text-slate-600 mb-0.5">Onze score</label>
                                <input type="text" data-id="${item.id}" value="${item.ourScore || ''}" class="our-score-input w-full p-1.5 border border-slate-300/50 rounded-md" placeholder="bv. 8/10">
                            </div>
                             <div>
                                <label class="block font-medium text-slate-600 mb-0.5">&nbsp;</label>
                                <button data-id="${item.id}" data-imdbid="${item.imdbID}" data-action="show-imdb" class="w-full bg-yellow-400/80 text-yellow-900 hover:bg-yellow-400 font-semibold py-1.5 px-2 rounded-md flex items-center justify-center gap-1.5">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22.44 15.6c.33.58.17 1.32-.39 1.7-.56.38-1.3.22-1.68-.36L18 13.28V20a1 1 0 01-1 1H7a1 1 0 01-1-1v-6.72l-2.37 3.66c-.38.58-1.12.74-1.68.36-.56-.38-.73-1.12-.39-1.7L5.1 9.42c.3-.53.83-.85 1.4-.85h10c.57 0 1.1.32 1.4.85l3.54 6.18zM18 4h-5V3a1 1 0 00-1-1H7a1 1 0 00-1 1v1H2a1 1 0 00-1 1v2a1 1 0 001 1h16a1 1 0 001-1V5a1 1 0 00-1-1z"/></svg>
                                    IMDB Info
                                </button>
                            </div>
                        </div>
                        ${dateSeenHTML}
                    </div>
                `;
                return div;
            },
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>

