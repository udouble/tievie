<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#0f172a"/>
  <title>MFS — v3.4 overlay + posters</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="./manifest.json">
  <style>
    .glass-card{background:rgba(255,255,255,.65);backdrop-filter:saturate(160%) blur(10px)}
    #status{position:fixed;right:12px;bottom:12px;background:#0ea5e9;color:#fff;padding:.4rem .6rem;border-radius:.6rem;font-size:.8rem;z-index:9999}
    ::placeholder{font-style:italic;color:#64748b}
    /* overlay */
    #suggestions-portal{position:fixed;left:0;top:0;width:100vw;height:100vh;pointer-events:none;z-index:99999}
    #suggestions{max-height:22rem;overflow:auto;pointer-events:auto}
    #suggestions .item:hover{background:rgba(0,0,0,.05)}
  </style>
</head>
<body class="bg-slate-100 text-slate-900">
<div class="max-w-6xl mx-auto p-4 pb-24">
  <header class="mb-3">
    <div class="mb-2 flex items-center justify-between gap-3">
      <h1 class="text-2xl font-bold">Mijn Films en Series</h1>
      <div class="flex gap-2 items-center">
        <button id="btn-import-json" class="px-3 py-2 rounded-xl bg-white/70 hover:bg-white shadow text-sm">Importeer JSON</button>
        <button id="btn-add-demo" class="px-3 py-2 rounded-xl bg-emerald-600 text-white shadow text-sm">Demo-items</button>
      </div>
    </div>
    <div class="glass-card rounded-xl p-3 shadow mb-3">
      <div class="flex flex-wrap items-center gap-2">
        <div class="relative grow min-w-[220px]">
          <input id="add-search" type="search" placeholder="Zoek en voeg toe… (bv. Matrix)" class="w-full px-3 py-2 rounded-lg bg-white/80 shadow">
        </div>
        <select id="add-type" class="px-2 py-2 rounded-lg bg-white/80 shadow">
          <option value="film" selected>Film</option>
          <option value="serie">Serie</option>
          <option value="herman-film">H-Film</option>
          <option value="herman-serie">H-Serie</option>
          <option value="aan-het-kijken">Aan het kijken</option>
          <option value="bekeken">Bekeken</option>
        </select>
        <select id="add-stream" class="px-2 py-2 rounded-lg bg-white/80 shadow">
          <option value="">— Waar te bekijken —</option>
          <option>Netflix</option><option>Disney+</option><option>Prime Video</option><option>Apple TV+</option>
          <option>VRT MAX</option><option>Play</option><option>Streamz</option><option>Videoland</option>
          <option>Blu-ray</option><option>iTunes</option>
        </select>
        <button id="btn-add-item" class="px-3 py-2 rounded-xl bg-indigo-600 text-white shadow">Voeg toe</button>
        <div class="flex-1"></div>
        <button id="btn-refresh-posters" class="px-3 py-2 rounded-xl bg-amber-500 text-white shadow">Posters bijwerken</button>
      </div>
    </div>
  </header>

  <section class="mb-3">
    <div id="filterControls" class="flex flex-wrap items-center gap-2">
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="film">Films</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="serie">Series</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="herman-film">H-Films</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="herman-serie">H-Series</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="aan-het-kijken">Aan het kijken</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="bekeken">Bekeken</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="all">Alles</button>
      <span id="countBadge" class="ml-2 text-sm text-slate-600"></span>
      <div class="flex-1"></div>
      <input id="search" type="search" placeholder="Zoeken in lijst…" class="px-3 py-2 rounded-lg bg-white/70 shadow w-48"/>
    </div>
  </section>

  <main>
    <div id="list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
    <p id="emptyState" class="hidden text-center text-slate-600 py-10">Je lijst is leeg.</p>
  </main>
</div>

<!-- Overlay portal -->
<div id="suggestions-portal">
  <div id="suggestions" class="hidden bg-white rounded-lg shadow-lg border border-slate-200"></div>
</div>

<div id="status">v3.4 geladen…</div>

<script>
const statusEl=document.getElementById('status');function setStatus(t){if(statusEl){statusEl.textContent=t}console.log('[STATUS]',t)}
const OMDB_KEY="8a70a767";const PLACEHOLDER='https://placehold.co/400x600/e2e8f0/94a3b8?text=Fout';
const DB_NAME='mfs-db', DB_VERSION=1, STORE='items';
function thumb(u){return u?('https://wsrv.nl/?url='+encodeURIComponent(u)+'&w=64&h=96&fit=cover&output=jpg'):''}
function poster(u){return u?('https://wsrv.nl/?url='+encodeURIComponent(u)+'&w=400&h=600&fit=cover&output=jpg'):''}
function norm(s){return (s||'').toString().trim().toLowerCase()}
function openDB(){return new Promise((ok,no)=>{const r=indexedDB.open(DB_NAME,DB_VERSION);r.onupgradeneeded=()=>{const db=r.result;if(!db.objectStoreNames.contains(STORE)){const s=db.createObjectStore(STORE,{keyPath:'id'});s.createIndex('createdAt','createdAt');s.createIndex('type','type')}};r.onsuccess=()=>ok(r.result);r.onerror=()=>no(r.error)})}
function tx(db,mode='readonly'){return db.transaction(STORE,mode).objectStore(STORE)}
async function dbGetAll(){const db=await openDB();return new Promise((ok,no)=>{const q=tx(db).getAll();q.onsuccess=()=>ok(q.result||[]);q.onerror=()=>no(q.error)})}
async function dbGet(id){const db=await openDB();return new Promise((ok,no)=>{const q=tx(db).get(id);q.onsuccess=()=>ok(q.result||null);q.onerror=()=>no(q.error)})}
async function dbPut(item){const db=await openDB();return new Promise((ok,no)=>{const p=tx(db,'readwrite').put(item);p.onsuccess=()=>ok();p.onerror=()=>no(p.error)})}
async function dbDelete(id){const db=await openDB();return new Promise((ok,no)=>{const d=tx(db,'readwrite').delete(id);d.onsuccess=()=>ok();d.onerror=()=>no(d.error)})}
const app={state:{items:[],filter:'all',searchTerm:''}};
function sameKey(a,b){const ta=norm(a.type),tb=norm(b.type);const ia=norm(a.imdbID),ib=norm(b.imdbID);if(ia&&ib)return ia===ib&&ta===tb;const taT=norm(a.title),tbT=norm(b.title);return taT&&tbT&&taT===tbT&&ta===tb}
async function upsertSmart(nv){const all=await dbGetAll();const ex=all.find(it=>sameKey(it,nv));if(!ex){if(!nv.id)nv.id='id-'+Date.now()+'-'+Math.random().toString(36).slice(2,7);if(!nv.createdAt)nv.createdAt=Date.now();await dbPut(nv);return 'inserted'}const m={...ex};['title','imdbRating','year','runtime','poster','streamingOn','ourScore','dateSeen','imdbID','type'].forEach(k=>{const n=(nv[k]??''),o=(ex[k]??'');if(!o&&n)m[k]=n;if(k==='poster'&&n&&n!=='N/A')m[k]=n});m.createdAt=Math.min(ex.createdAt||Date.now(),nv.createdAt||Date.now());m.id=ex.id;await dbPut(m);return 'updated'}
async function omdbById(id){if(!id)return null;try{const r=await fetch(`https://www.omdbapi.com/?apikey=${encodeURIComponent(OMDB_KEY)}&r=json&i=${encodeURIComponent(id)}`);return await r.json()}catch(e){return null}}
async function omdbSearch(q){try{const r=await fetch(`https://www.omdbapi.com/?apikey=${encodeURIComponent(OMDB_KEY)}&r=json&s=${encodeURIComponent(q)}`);return await r.json()}catch(e){return null}}
async function ensurePoster(item,img){if(item.poster&&item.poster!=='N/A'){img.src=poster(item.poster);return}if(!item.imdbID){img.src=PLACEHOLDER;return}const d=await omdbById(item.imdbID);const p=(d&&d.Poster&&d.Poster!=='N/A')?d.Poster:'';if(p){item.poster=p;img.src=poster(p);await dbPut(item)}else{img.src=PLACEHOLDER}}
window._posterErrorHandler=async function(img){if(img.dataset.retry==='1'){img.onerror=null;img.src=PLACEHOLDER;return}img.dataset.retry='1';const it=await dbGet(img.dataset.itemId||'');if(it){const d=await omdbById(it.imdbID||'');const p=(d&&d.Poster&&d.Poster!=='N/A')?d.Poster:'';if(p){it.poster=p;await dbPut(it);img.src=poster(p);return}}img.src=PLACEHOLDER};
function tagCfg(t){const m={film:{c:'bg-sky-200/80 text-sky-900',t:'Film'},serie:{c:'bg-amber-200/80 text-amber-900',t:'Serie'},'herman-film':{c:'bg-purple-200/80 text-purple-900',t:'H-Film'},'herman-serie':{c:'bg-pink-200/80 text-pink-900',t:'H-Serie'},'aan-het-kijken':{c:'bg-blue-200/80 text-blue-900',t:'Aan het kijken'},bekeken:{c:'bg-green-200/80 text-green-900',t:'Bekeken'}};return m[t]||{c:'bg-slate-200/80 text-slate-900',t:t}}
function streamingOptionsHTML(sel){return ['','Netflix','Disney+','Prime Video','Apple TV+','VRT MAX','Play','Streamz','Videoland','Blu-ray','iTunes'].map(o=>`<option value="${o}" ${sel===o?'selected':''}>${o}</option>`).join('')}
function categoryOptionsHTML(type){const m={film:'Film',serie:'Serie','herman-film':'H-Film','herman-serie':'H-Serie','aan-het-kijken':'Aan het kijken',bekeken:'Bekeken'};return Object.keys(m).map(k=>`<option value="${k}" ${type===k?'selected':''}>${m[k]}</option>`).join('')}
app.card=function(item,idx){const el=document.createElement('div');el.className='glass-card rounded-xl flex flex-col overflow-hidden shadow-lg text-slate-800';const tag=tagCfg(item.type);const imgSrc=(item.poster&&item.poster!=='N/A')?poster(item.poster):PLACEHOLDER;const scoreVal=(!item.ourScore||(''+item.ourScore).toLowerCase()==='nan')?'':item.ourScore;el.innerHTML=`
<div class="flex">
  <div class="w-1/2 flex-shrink-0 relative">
    <div class="aspect-[2/3] w-full">
      <img src="${imgSrc}" data-item-id="${item.id||''}" onerror="_posterErrorHandler(this)" alt="Poster van ${item.title}" class="w-full h-full object-cover">
    </div>
    <div class="absolute top-2 left-2 bg-black/70 text-white w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm">${idx}</div>
  </div>
  <div class="p-3 flex flex-col flex-grow w-1/2">
    <h3 class="font-bold text-base leading-tight mb-2">${item.title}</h3>
    <div class="text-sm text-slate-700 space-y-0.5 mb-2">
      <p><strong>IMDB:</strong> ${item.imdbRating||'N/B'}</p>
      <p><strong>Jaar:</strong> ${item.year||'N/B'}</p>
      <p><strong>Duur:</strong> ${item.runtime||'N/B'}</p>
    </div>
    <div class="mb-2 flex justify-between items-center">
      <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${tag.c}">${tag.t}</span>
      <button data-id="${item.id||''}" data-action="delete" title="Verwijderen" class="bg-white/50 text-slate-600 hover:bg-red-500 hover:text-white w-7 h-7 flex items-center justify-center rounded-full transition-all">
        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>
    <div class="flex flex-col gap-2 mt-1">
      <input type="text" data-id="${item.id||''}" value="${scoreVal||''}" class="our-score-input w-full p-1.5 border border-slate-300/50 rounded-md text-xs" placeholder="Nog geen score">
      <button data-id="${item.id||''}" data-imdbid="${item.imdbID||''}" data-action="show-imdb" class="w-full bg-yellow-400/80 text-yellow-900 hover:bg-yellow-400 font-semibold py-1.5 px-2 rounded-md text-xs">IMDB Info</button>
    </div>
  </div>
</div>
<div class="p-3 pt-2 text-xs space-y-2 border-t border-white/20">
  <div class="grid grid-cols-2 gap-2">
    <div>
      <label class="block font-medium text-slate-600 mb-0.5">Categorie</label>
      <select data-id="${item.id||''}" class="category-select w-full p-1.5 border border-slate-300/50 rounded-md">
        ${categoryOptionsHTML(item.type)}
      </select>
    </div>
    <div>
      <label class="block font-medium text-slate-600 mb-0.5">Waar te bekijken</label>
      <select data-id="${item.id||''}" class="streaming-service-select w-full p-1.5 border border-slate-300/50 rounded-md">
        ${streamingOptionsHTML(item.streamingOn)}
      </select>
    </div>
  </div>
  ${item.type==='bekeken'?`<div><label class="block font-medium text-slate-600 mb-0.5">Laatst gezien op</label><input type="date" data-id="${item.id||''}" value="${item.dateSeen||''}" class="date-seen-input w-full p-1.5 border border-slate-300/50 rounded-md"></div>`:''}
</div>`;
  setTimeout(()=>{
    const img=el.querySelector('img[data-item-id]');ensurePoster(item,img);
    el.querySelector('[data-action="delete"]').onclick=async()=>{await dbDelete(item.id);app.state.items=await dbGetAll();app.render()};
    el.querySelector('.our-score-input').onchange=async(e)=>{item.ourScore=e.target.value;await dbPut(item)};
    el.querySelector('.category-select').onchange=async(e)=>{item.type=e.target.value;await dbPut(item);app.render()};
    el.querySelector('.streaming-service-select').onchange=async(e)=>{item.streamingOn=e.target.value;await dbPut(item)};
    const infoBtn=el.querySelector('[data-action="show-imdb"]');infoBtn.onclick=()=>{const id=item.imdbID;if(id){window.open('https://www.imdb.com/title/'+id,'_blank')}else{alert('Geen IMDb ID beschikbaar.')}};
    const dateInput=el.querySelector('.date-seen-input');if(dateInput){dateInput.onchange=async(e)=>{item.dateSeen=e.target.value;await dbPut(item)}};
  },0);
  return el;
}
app.filtered=function(){let a=app.state.items.slice();const t=(app.state.searchTerm||'').toLowerCase();if(app.state.filter!=='all')a=a.filter(i=>i.type===app.state.filter);if(t)a=a.filter(i=>(i.title||'').toLowerCase().includes(t));a.sort((x,y)=>(y.createdAt||0)-(x.createdAt||0));return a}
app.render=function(){const list=document.getElementById('list'),empty=document.getElementById('emptyState');list.innerHTML='';document.querySelectorAll('#filterControls .filter-btn').forEach(b=>{const act=b.dataset.filter===app.state.filter;b.classList.toggle('bg-indigo-600',act);b.classList.toggle('text-white',act);b.classList.toggle('bg-white/50',!act);b.classList.toggle('text-slate-800',!act)});const items=app.filtered();const badge=document.getElementById('countBadge');const label=app.state.filter==='all'?'Alles':document.querySelector(`.filter-btn[data-filter="${app.state.filter}"]`)?.textContent||app.state.filter;badge.textContent=`${label}: ${items.length}`;if(items.length===0){empty.classList.remove('hidden');return}empty.classList.add('hidden');items.forEach((it,i)=>list.appendChild(app.card(it,i+1)))}
function bindUI(){document.getElementById('btn-import-json').onclick=()=>app.importJSON();document.getElementById('btn-add-demo').onclick=()=>app.addDemo();document.getElementById('btn-add-item').onclick=handleAddItem;document.getElementById('btn-refresh-posters').onclick=refreshVisiblePosters;setupSuggestionsOverlay();}
function setupSuggestionsOverlay(){const field=document.getElementById('add-search');const box=document.getElementById('suggestions');let t;function place(){const r=field.getBoundingClientRect();box.style.position='fixed';box.style.left=r.left+'px';box.style.top=(r.bottom+4)+'px';box.style.width=r.width+'px'}field.addEventListener('focus',place);window.addEventListener('resize',place);window.addEventListener('scroll',place,true);field.addEventListener('input',()=>{clearTimeout(t);const q=field.value.trim();if(q.length<2){box.classList.add('hidden');box.innerHTML='';return}t=setTimeout(async()=>{place();const data=await omdbSearch(q);const res=(data&&Array.isArray(data.Search))?data.Search:[];if(res.length===0){box.classList.add('hidden');box.innerHTML='';return}box.innerHTML=res.map(r=>{const p=(r.Poster&&r.Poster!=='N/A')?thumb(r.Poster):'https://placehold.co/64x96/e2e8f0/94a3b8?text=?';return `<div class="item px-2 py-2 cursor-pointer flex items-center gap-2" data-imdbid="${r.imdbID}" data-title="${r.Title}"><img src="${p}" class="w-16 h-24 object-cover rounded"/><div class="min-w-0"><div class="truncate">${r.Title}</div><div class="text-slate-500 text-xs">${r.Year||''} • ${r.Type||''}</div></div></div>`}).join('');box.classList.remove('hidden');box.querySelectorAll('.item').forEach(el=>{el.onclick=()=>{field.value=el.dataset.title;field.dataset.imdbid=el.dataset.imdbid;box.classList.add('hidden');box.innerHTML=''}})},300)});document.addEventListener('click',(e)=>{if(e.target===field||box.contains(e.target))return;box.classList.add('hidden')})}
async function handleAddItem(){const field=document.getElementById('add-search');const title=(field.value||'').trim();const imdbID=(field.dataset.imdbid||'').trim();const type=document.getElementById('add-type').value;const stream=document.getElementById('add-stream').value;if(!title){alert('Geef een titel in of kies een suggestie.');return}let d=null;if(imdbID){d=await omdbById(imdbID)}const item={title,type,createdAt:Date.now(),imdbRating:d?.imdbRating||'',year:d?.Year||'',runtime:d?.Runtime||'',poster:(d&&d.Poster&&d.Poster!=='N/A')?d.Poster:'',streamingOn:stream,ourScore:'',dateSeen:'',imdbID};await upsertSmart(item);app.state.items=await dbGetAll();app.state.filter=type;app.render();field.value='';field.dataset.imdbid='';document.getElementById('add-stream').value=''}
async function refreshVisiblePosters(){const list=document.getElementById('list');const imgs=list.querySelectorAll('img[data-item-id]');for(const img of imgs){const id=img.getAttribute('data-item-id');const it=await dbGet(id);if(it){it.poster='';await dbPut(it);await ensurePoster(it,img)}}setStatus('Posters bijgewerkt voor zichtbare items')}
app.importJSON=function(){setStatus('Import JSON…');const picker=document.createElement('input');picker.type='file';picker.accept='application/json';picker.onchange=()=>{(async()=>{try{const f=picker.files[0];if(!f){setStatus('Geen bestand gekozen');return}const text=await f.text();let data;try{data=JSON.parse(text)}catch(e){alert('Geen geldige JSON');setStatus('JSON fout');return}let arr=Array.isArray(data)?data:(Array.isArray(data.items)?data.items:[]);let ins=0,upd=0;for(const raw of arr){const score=(raw.ourScore==null)?'':String(raw.ourScore);const cleaned=(typeof score==='string'&&score.toLowerCase()==='nan')?'':score;const item={id:raw.id,title:raw.title||'Onbekend',type:raw.type||'film',createdAt:raw.createdAt||Date.now(),imdbRating:raw.imdbRating||'',year:raw.year||'',runtime:raw.runtime||'',poster:raw.poster||'',streamingOn:raw.streamingOn||'',ourScore:cleaned,dateSeen:raw.dateSeen||'',imdbID:raw.imdbID||raw.imdbId||''};const res=await upsertSmart(item);if(res==='inserted')ins++;else if(res==='updated')upd++;}app.state.items=await dbGetAll();app.render();alert(`Import klaar. Nieuw: ${ins} · Bijgewerkt: ${upd}`);setStatus('Import klaar')}catch(err){console.error(err);setStatus('Import error')}})()};picker.click()};
document.addEventListener('DOMContentLoaded',async()=>{bindUI();app.state.items=await dbGetAll();app.render();setStatus('v3.4 actief')});
</script>
</body>
</html>
