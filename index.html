<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#0f172a"/>
  <title>MFS — v3.17 (confirm add)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="./manifest.json">
  <style>
    .glass-card{background:rgba(255,255,255,.65);backdrop-filter:saturate(160%) blur(10px)}
    #status{position:fixed;right:12px;bottom:12px;background:#0ea5e9;color:#fff;padding:.35rem .6rem;border-radius:.6rem;font-size:.8rem;z-index:9999}
    ::placeholder{font-style:italic;color:#64748b}
    select.italic { font-style: italic; color:#475569; }
    .backdrop{position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;z-index:99998}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:99999}
    /* Suggestie overlay — echte overlay boven alles, position: fixed */
    #suggest{position:fixed;display:none;z-index:100000}
    #suggest .card{max-height:360px;overflow:auto}
    #suggest img{width:44px;height:66px;object-fit:cover;border-radius:.375rem}
    #suggest .row{display:flex;gap:.6rem;align-items:center;padding:.5rem .6rem;border-radius:.6rem}
    #suggest .row:hover{background:rgba(2,6,23,.06)}
  </style>
</head>
<body class="bg-slate-100 text-slate-900">
<div class="max-w-6xl mx-auto p-4 pb-24">
  <header class="mb-3">
    <div class="mb-2 flex items-center justify-between gap-3">
      <h1 class="text-2xl font-bold">Mijn Films en Series</h1>
      <div class="flex gap-2 items-center">
        <button id="btn-import-json" class="px-3 py-2 rounded-xl bg-white/70 hover:bg-white shadow text-sm">Importeer JSON</button>
        <button id="btn-export-json" class="px-3 py-2 rounded-xl bg-white/70 hover:bg-white shadow text-sm">Exporteer alles</button>
      </div>
    </div>

    <div class="glass-card rounded-xl p-3 shadow mb-3 flex flex-wrap items-center gap-2">
      <label for="sortBy" class="text-sm text-slate-600">Sorteren</label>
      <select id="sortBy" class="px-2 py-1.5 rounded-lg bg-white/80 shadow text-sm">
        <option value="created_desc" selected>Nummer (recent → oud)</option>
        <option value="imdb_desc">IMDb-score hoog → laag</option>
        <option value="imdb_asc">IMDb-score laag → hoog</option>
        <option value="title_asc">Titel A → Z</option>
        <option value="title_desc">Titel Z → A</option>
      </select>
      <div class="h-5 w-px bg-slate-200 mx-1"></div>
      <label for="filterStreaming" class="text-sm text-slate-600">Streaming</label>
      <select id="filterStreaming" class="px-2 py-1.5 rounded-lg bg-white/80 shadow text-sm">
        <option value="">Alle diensten</option>
        <option>Streamz</option>
        <option>Netflix</option>
        <option>Prime Video</option>
        <option>Apple TV+</option>
        <option>VRT MAX</option>
        <option>Go Play</option>
        <option>NPO</option>
        <option>Disney+</option>
        <option value="__UNKNOWN__">Onbekend</option>
      </select>

      <span id="countBadge" class="ml-auto text-sm text-slate-600"></span>

      <button id="btn-random-pick" class="px-3 py-1.5 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 3l2.1 5.1L19 10l-4.5 3.3L15 19l-3-2-3 2 0.5-5.7L5 10l4.9-1.9L12 3z"/>
        </svg>
        Kies iets voor me
      </button>
    </div>

    <div class="glass-card rounded-xl p-3 shadow mb-3">
      <div class="flex flex-wrap items-center gap-2">
        <div class="relative grow min-w-[240px]">
          <input id="add-search" type="search" placeholder="Zoek en voeg toe… (bv. Matrix)" class="w-full px-3 py-2 rounded-lg bg-white/80 shadow">
        </div>
        <select id="add-type" class="px-2 py-2 rounded-lg bg-white/80 shadow">
          <option value="film" selected>Film</option>
          <option value="serie">Serie</option>
          <option value="herman-film">H-Film</option>
          <option value="herman-serie">H-Serie</option>
          <option value="aan-het-kijken">Aan het kijken</option>
          <option value="bekeken">Bekeken</option>
        </select>
        <select id="add-stream" class="px-2 py-2 rounded-lg bg-white/80 shadow">
          <option value="">Onbekend</option>
          <option>Streamz</option>
          <option>Netflix</option>
          <option>Prime Video</option>
          <option>Apple TV+</option>
          <option>VRT MAX</option>
          <option>Go Play</option>
          <option>NPO</option>
          <option>Disney+</option>
        </select>
        <button id="btn-add-item" class="px-3 py-2 rounded-xl bg-indigo-600 text-white shadow">Voeg toe</button>
      </div>
    </div>
  </header>

  <section class="mb-3">
    <div id="filterControls" class="flex flex-wrap items-center gap-2">
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="film">Films</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="serie">Series</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="herman-film">H-Films</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="herman-serie">H-Series</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="aan-het-kijken">Aan het kijken</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="bekeken">Bekeken</button>
      <button class="filter-btn px-3 py-1.5 rounded-lg bg-white/50" data-filter="all">Alles</button>
      <div class="flex-1"></div>
      <input id="search" type="search" placeholder="Zoeken in lijst…" class="px-3 py-2 rounded-lg bg-white/70 shadow w-48"/>
    </div>
  </section>

  <main>
    <div id="list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
    <p id="emptyState" class="hidden text-center text-slate-600 py-10">Je lijst is leeg.</p>
  </main>
</div>

<!-- Suggest overlay -->
<div id="suggest">
  <div class="card bg-white rounded-xl shadow-2xl border border-slate-200">
    <div id="suggest-list" class="p-2"></div>
    <div id="suggest-empty" class="p-3 text-sm text-slate-500 hidden">Geen resultaten…</div>
  </div>
</div>

<!-- Confirm add modal -->
<div id="add-backdrop" class="backdrop"></div>
<div id="add-modal" class="modal">
  <div class="bg-white rounded-2xl shadow-2xl w-[92vw] max-w-lg overflow-hidden">
    <div class="flex items-start gap-3 p-3 border-b border-slate-200">
      <img id="add-preview" class="w-20 h-28 object-cover rounded-lg" alt="Poster"/>
      <div class="flex-1">
        <h3 id="add-title" class="text-lg font-semibold leading-tight">Titel</h3>
        <p id="add-sub" class="text-sm text-slate-600"></p>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <div>
            <label class="block text-xs text-slate-600 mb-1">Categorie</label>
            <select id="confirm-type" class="w-full px-2 py-1.5 rounded-md bg-white/90 border border-slate-200">
              <option value="film">Film</option>
              <option value="serie">Serie</option>
              <option value="herman-film">H-Film</option>
              <option value="herman-serie">H-Serie</option>
              <option value="aan-het-kijken">Aan het kijken</option>
              <option value="bekeken">Bekeken</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-slate-600 mb-1">Waar te bekijken</label>
            <select id="confirm-stream" class="w-full px-2 py-1.5 rounded-md bg-white/90 border border-slate-200">
              <option value="">Onbekend</option>
              <option>Streamz</option>
              <option>Netflix</option>
              <option>Prime Video</option>
              <option>Apple TV+</option>
              <option>VRT MAX</option>
              <option>Go Play</option>
              <option>NPO</option>
              <option>Disney+</option>
            </select>
          </div>
        </div>
      </div>
      <button id="add-close" class="ml-1 text-slate-500 hover:text-slate-700 p-1" title="Sluiten">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="p-3 flex justify-end gap-2">
      <button id="add-cancel" class="px-3 py-1.5 rounded-xl bg-white border border-slate-200 text-slate-700">Annuleer</button>
      <button id="add-confirm" class="px-3 py-1.5 rounded-xl bg-indigo-600 text-white">Voeg toe</button>
    </div>
  </div>
</div>

<!-- Random popover -->
<div id="random-backdrop" class="backdrop"></div>
<div id="random-modal" class="modal">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-[90vw] overflow-hidden">
    <div class="flex gap-3 p-3">
      <img id="rnd-poster" alt="Poster" class="w-24 h-36 object-cover rounded-lg flex-shrink-0">
      <div class="flex flex-col">
        <h3 id="rnd-title" class="text-lg font-semibold leading-snug"></h3>
        <p id="rnd-meta" class="text-sm text-slate-600 mt-1"></p>
        <div id="rnd-stream" class="text-xs text-slate-500 mt-1"></div>
        <div class="mt-auto flex gap-2 pt-2">
          <button id="rnd-ok" class="px-3 py-1.5 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm">OK</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="status">v3.17 geladen…</div>

<script>
const statusEl=document.getElementById('status');function setStatus(t){if(statusEl){statusEl.textContent=t}console.log('[STATUS]',t)}
const DB_NAME='mfs-db', DB_VERSION=1, STORE='items';
const PLACEHOLDER='https://placehold.co/400x600/e2e8f0/94a3b8?text=Fout';
const OMDB_KEY='8a70a767';

async function ensurePersistent(){ if(navigator.storage && navigator.storage.persist) { try{ const granted = await navigator.storage.persist(); console.log('persist?', granted); }catch(e){} } }

function normalizeStream(raw){
  const s=(raw||'').toString().trim();
  if(!s) return '';
  const low=s.toLowerCase();
  if(low.startsWith('appl')) return 'Apple TV+';
  if(low.startsWith('netf')) return 'Netflix';
  if(low.startsWith('vrt'))  return 'VRT MAX';
  if(low.startsWith('vtm'))  return 'VTM Go';
  if(low.startsWith('prim')) return 'Prime Video';
  if(low.includes('play'))   return 'Go Play';
  if(low.startsWith('np'))   return 'NPO';
  if(low.startsWith('strea'))return 'Streamz';
  if(low.startsWith('disn')) return 'Disney+';
  return '';
}
const STREAM_ORDER=['Streamz','Netflix','Prime Video','Apple TV+','VRT MAX','Go Play','NPO','Disney+'];

function poster(u,w=400,h=600){return u?('https://wsrv.nl/?url='+encodeURIComponent(u)+`&w=${w}&h=${h}&fit=cover&output=jpg`):''}
function parseImdb(v){if(v==null)return NaN;const f=parseFloat(String(v));return isNaN(f)?NaN:f}
function debounce(fn,ms){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}

function openDB(){return new Promise((ok,no)=>{const r=indexedDB.open(DB_NAME,DB_VERSION);r.onupgradeneeded=()=>{const db=r.result;if(!db.objectStoreNames.contains(STORE)){const s=db.createObjectStore(STORE,{keyPath:'id'});s.createIndex('createdAt','createdAt');s.createIndex('type','type')}};r.onsuccess=()=>ok(r.result);r.onerror=()=>no(r.error)})}
function tx(db,mode='readonly'){return db.transaction(STORE,mode).objectStore(STORE)}
async function dbGetAll(){const db=await openDB();return new Promise((ok,no)=>{const q=tx(db).getAll();q.onsuccess=()=>ok(q.result||[]);q.onerror=()=>no(q.error)})}
async function dbPut(item){const db=await openDB();return new Promise((ok,no)=>{const p=tx(db,'readwrite').put(item);p.onsuccess=()=>ok();p.onerror=()=>no(p.error)})}

const app={state:{items:[],filter:'all',searchTerm:'',sortBy:'created_desc',filterStreaming:''}};

app.filtered=function(){
  let a=app.state.items.slice();
  if(app.state.filter!=='all') a=a.filter(i=>i.type===app.state.filter);
  const fs=app.state.filterStreaming;
  if(fs==='__UNKNOWN__'){ a=a.filter(i=>!normalizeStream(i.streamingOn)); }
  else if(fs){ a=a.filter(i=>normalizeStream(i.streamingOn)===fs); }
  const term=(app.state.searchTerm||'').toLowerCase();
  if(term){
    a=a.filter(i=>{
      const t=(i.title||'').toLowerCase();
      const y=(i.year||'').toString();
      const s=(normalizeStream(i.streamingOn)||'').toLowerCase();
      const id=(i.imdbID||'').toLowerCase();
      return t.includes(term)||y.includes(term)||s.includes(term)||id.includes(term);
    });
  }
  const by=app.state.sortBy;
  if(by==='imdb_desc'){ a.sort((x,y)=> (parseImdb(y.imdbRating)||-1)-(parseImdb(x.imdbRating)||-1)); }
  else if(by==='imdb_asc'){ a.sort((x,y)=> (parseImdb(x.imdbRating)||-1)-(parseImdb(y.imdbRating)||-1)); }
  else if(by==='title_asc'){ a.sort((x,y)=> (x.title||'').localeCompare(y.title||'')); }
  else if(by==='title_desc'){ a.sort((x,y)=> (y.title||'').localeCompare(x.title||'')); }
  else { a.sort((x,y)=>(y.createdAt||0)-(x.createdAt||0)); }
  return a;
};

function categoryOptionsHTML(type){
  const m={film:'Film',serie:'Serie','herman-film':'H-Film','herman-serie':'H-Serie','aan-het-kijken':'Aan het kijken',bekeken:'Bekeken'};
  return Object.keys(m).map(k=>`<option value="${k}" ${type===k?'selected':''}>${m[k]}</option>`).join('');
}
function streamingOptionsHTML(sel){
  const opts=[''].concat(STREAM_ORDER);
  return opts.map(o=>`<option value="${o}" ${sel===o?'selected':''}>${o||'Onbekend'}</option>`).join('');
}

function ensurePoster(item,img){const src=(item.poster&&item.poster!=='N/A')?poster(item.poster):'https://placehold.co/400x600/e2e8f0/94a3b8?text=Fout';img.src=src}

app.card=function(item,idx){
  const el=document.createElement('div');el.className='glass-card rounded-xl flex flex-col overflow-hidden shadow-lg text-slate-800';
  const tagMap={film:{c:'bg-sky-200/80 text-sky-900',t:'Film'},serie:{c:'bg-amber-200/80 text-amber-900',t:'Serie'},'herman-film':{c:'bg-purple-200/80 text-purple-900',t:'H-Film'},'herman-serie':{c:'bg-pink-200/80 text-pink-900',t:'H-Serie'},'aan-het-kijken':{c:'bg-blue-200/80 text-blue-900',t:'Aan het kijken'},bekeken:{c:'bg-green-200/80 text-green-900',t:'Bekeken'}};
  const tag=tagMap[item.type]||{c:'bg-slate-200/80 text-slate-900',t:item.type};
  const imgSrc=(item.poster&&item.poster!=='N/A')?poster(item.poster):'https://placehold.co/400x600/e2e8f0/94a3b8?text=Fout';
  const scoreVal=(!item.ourScore||(''+item.ourScore).toLowerCase()==='nan')?'':item.ourScore;
  const streamSel=normalizeStream(item.streamingOn);
  el.innerHTML=`
<div class="flex">
  <div class="w-1/2 flex-shrink-0 relative">
    <div class="aspect-[2/3] w-full"><img src="${imgSrc}" alt="Poster" class="w-full h-full object-cover"></div>
    <div class="absolute top-2 left-2 bg-black/70 text-white w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm">${idx}</div>
  </div>
  <div class="p-3 flex flex-col flex-grow w-1/2">
    <div class="mb-2 flex justify-between items-center">
      <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${tag.c}">${tag.t}</span>
      <button title="Verwijderen" data-id="${item.id}" class="btn-delete bg-white/50 text-slate-600 hover:bg-red-500 hover:text-white w-7 h-7 flex items-center justify-center rounded-full transition-all">
        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <h3 class="font-bold text-base leading-tight mb-2">${item.title}</h3>
    <div class="text-sm text-slate-700 space-y-0.5 mb-2">
      <p><strong>IMDB:</strong> ${item.imdbRating||'N/B'}</p>
      <p><strong>Jaar:</strong> ${item.year||'N/B'}</p>
      <p><strong>Duur:</strong> ${item.runtime||'N/B'}</p>
    </div>
    <div class="flex flex-col gap-2 mt-1">
      <input type="text" value="${scoreVal||''}" class="our-score-input w-full p-1.5 border border-slate-300/50 rounded-md text-xs" placeholder="Nog geen score">
      <button class="btn-imdb w-full bg-yellow-400/80 text-yellow-900 hover:bg-yellow-400 font-semibold py-1.5 px-2 rounded-md text-xs" data-imdbid="${item.imdbID||''}">IMDb-info</button>
    </div>
  </div>
</div>
<div class="p-3 pt-2 text-xs space-y-2 border-t border-white/20">
  <div class="grid grid-cols-2 gap-2">
    <div>
      <label class="block font-medium text-slate-600 mb-0.5">Categorie</label>
      <select class="category-select w-full p-1.5 border border-slate-300/50 rounded-md">
        ${categoryOptionsHTML(item.type)}
      </select>
    </div>
    <div>
      <label class="block font-medium text-slate-600 mb-0.5">Waar te bekijken</label>
      <select class="streaming-service-select w-full p-1.5 border border-slate-300/50 rounded-md ${streamSel?'':'italic'}">
        ${streamingOptionsHTML(streamSel)}
      </select>
    </div>
  </div>
  ${item.type==='bekeken'?`<div><label class="block text-slate-600 mb-0.5">Laatst gezien op</label><input type="date" value="${item.dateSeen||''}" class="date-seen-input w-full p-1.5 border border-slate-300/50 rounded-md"></div>`:''}
</div>`;

  el.querySelector('.btn-delete').addEventListener('click', async()=>{
    if(!confirm('Verwijderen?')) return;
    await dbDel(item.id);
    app.state.items = await dbGetAll();
    app.render();
  });
  el.querySelector('.btn-imdb').addEventListener('click', (e)=>{
    const id=e.currentTarget.dataset.imdbid;
    if(!id){ alert('Geen IMDb ID'); return; }
    window.open(`https://www.imdb.com/title/${id}/`, '_blank');
  });

  return el;
}

function openDB(){return new Promise((ok,no)=>{const r=indexedDB.open(DB_NAME,DB_VERSION);r.onupgradeneeded=()=>{const db=r.result;if(!db.objectStoreNames.contains(STORE)){const s=db.createObjectStore(STORE,{keyPath:'id'});s.createIndex('createdAt','createdAt');s.createIndex('type','type')}};r.onsuccess=()=>ok(r.result);r.onerror=()=>no(r.error)})}
function tx(db,mode='readonly'){return db.transaction(STORE,mode).objectStore(STORE)}
async function dbDel(id){const db=await openDB();return new Promise((ok,no)=>{const p=tx(db,'readwrite').delete(id);p.onsuccess=()=>ok();p.onerror=()=>no(p.error)})}

app.render=function(){
  const list=document.getElementById('list'),empty=document.getElementById('emptyState');list.innerHTML='';
  document.querySelectorAll('#filterControls .filter-btn').forEach(b=>{
    const act=b.dataset.filter===app.state.filter;
    b.classList.toggle('bg-indigo-600',act);b.classList.toggle('text-white',act);
    b.classList.toggle('bg-white/50',!act);b.classList.toggle('text-slate-800',!act);
  });
  const items=app.filtered();
  const badge=document.getElementById('countBadge');
  const label=app.state.filter==='all'?'Alles':document.querySelector(`.filter-btn[data-filter="${app.state.filter}"]`)?.textContent||app.state.filter;
  badge.textContent=`${label}: ${items.length}`;
  if(items.length===0){empty.classList.remove('hidden');return}
  empty.classList.add('hidden');
  items.forEach((it,i)=>list.appendChild(app.card(it,i+1)));
};

function bindUI(){
  document.getElementById('btn-import-json').onclick=()=>app.importJSON();
  document.getElementById('btn-export-json').onclick=exportAll;

  const sortBy=document.getElementById('sortBy');
  const filterStreaming=document.getElementById('filterStreaming');
  sortBy.addEventListener('change',()=>{app.state.sortBy=sortBy.value;app.render()});
  filterStreaming.addEventListener('change',()=>{app.state.filterStreaming=filterStreaming.value;app.render()});

  document.getElementById('filterControls').addEventListener('click',e=>{
    const b=e.target.closest('.filter-btn'); if(!b) return; app.state.filter=b.dataset.filter; app.render();
  });

  const search=document.getElementById('search');
  ['input','keyup','change','search','paste','cut'].forEach(evt=>{
    search.addEventListener(evt,(e)=>{app.state.searchTerm=e.target.value.trim();app.render()});
  });

  const addSearch=document.getElementById('add-search');
  ['input','keyup','change','search','paste','cut'].forEach(evt=>{
    addSearch.addEventListener(evt,(e)=>omdbSearch(e.target.value.trim()));
  });
  document.addEventListener('click',(e)=>{
    const input=document.getElementById('add-search');
    const sug=document.getElementById('suggest');
    if(e.target!==input && !sug.contains(e.target)) hideSuggest();
  });
  ['resize','scroll'].forEach(evt=>window.addEventListener(evt, placeSuggestOverlay));

  document.getElementById('btn-random-pick').addEventListener('click',()=>{
    const pool = app.filtered().filter(i=> i.type==='film' || i.type==='serie');
    if(!pool.length){ alert('Geen films/series in deze selectie.'); return; }
    const x = pool[Math.floor(Math.random()*pool.length)];
    showRandom(x);
  });

  // Confirm modal buttons
  document.getElementById('add-close').onclick=closeAddModal;
  document.getElementById('add-cancel').onclick=closeAddModal;
  document.getElementById('add-confirm').onclick=confirmAddSelection;
}

function exportAll(){
  const data = JSON.stringify({ items: app.state.items }, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'mfs-backup.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

function placeSuggestOverlay(){
  const sug=document.getElementById('suggest');
  if(sug.style.display!=='block') return;
  const input=document.getElementById('add-search');
  const r=input.getBoundingClientRect();
  const top=r.bottom + window.scrollY + 8;
  const left=r.left + window.scrollX;
  const width=r.width;
  sug.style.top = top+'px';
  sug.style.left = left+'px';
  sug.style.width = width+'px';
}
function hideSuggest(){document.getElementById('suggest').style.display='none'}
function renderSuggest(list){
  const sug=document.getElementById('suggest');
  const ul=document.getElementById('suggest-list');
  const empty=document.getElementById('suggest-empty');
  ul.innerHTML='';
  if(!list.length){ empty.classList.remove('hidden'); sug.style.display='block'; placeSuggestOverlay(); return; }
  empty.classList.add('hidden');
  list.forEach(hit=>{
    const row=document.createElement('button'); row.type='button'; row.className='row w-full text-left';
    const p=(hit.Poster && hit.Poster!=='N/A')?poster(hit.Poster,80,120):'https://placehold.co/80x120/e2e8f0/94a3b8?text=—';
    row.innerHTML=`<img src="${p}" alt=""><div class="flex flex-col"><div class="font-medium leading-tight">${hit.Title||'—'}</div><div class="text-xs text-slate-600">${hit.Year||''} · ${hit.Type}</div></div>`;
    row.addEventListener('click',()=>openAddModal(hit));
    ul.appendChild(row);
  });
  sug.style.display='block';
  placeSuggestOverlay();
}
const omdbSearch = debounce(async(q)=>{
  if(!q || q.length<2){ hideSuggest(); return; }
  try{
    const typeSel=document.getElementById('add-type').value;
    const omdbType=(typeSel==='film')?'movie':(typeSel==='serie')?'series':'';
    const url=`https://www.omdbapi.com/?apikey=${OMDB_KEY}&s=${encodeURIComponent(q)}${omdbType?`&type=${omdbType}`:''}`;
    const res=await fetch(url); const data=await res.json();
    if(data && data.Search){ renderSuggest(data.Search.slice(0,40)); } else { renderSuggest([]); }
  }catch(e){ console.error(e); renderSuggest([]); }
},200);

let pendingHit=null;
function openAddModal(hit){
  pendingHit = hit;
  // Prefill modal
  const img=(hit.Poster && hit.Poster!=='N/A')?hit.Poster:'';
  document.getElementById('add-preview').src = img ? poster(img,160,240) : 'https://placehold.co/160x240/e2e8f0/94a3b8?text=—';
  document.getElementById('add-title').textContent = hit.Title || '—';
  document.getElementById('add-sub').textContent = `${hit.Year||''} · ${hit.Type||''}`;

  // Defaults from the small selectors (so jouw voorkeur telt)
  document.getElementById('confirm-type').value = document.getElementById('add-type').value || 'film';
  document.getElementById('confirm-stream').value = document.getElementById('add-stream').value || '';

  // Show modal
  document.getElementById('add-backdrop').style.display='block';
  document.getElementById('add-modal').style.display='flex';
}
function closeAddModal(){
  document.getElementById('add-backdrop').style.display='none';
  document.getElementById('add-modal').style.display='none';
}
async function confirmAddSelection(){
  if(!pendingHit) return;
  const typeSel=document.getElementById('confirm-type').value;
  const streamSel=document.getElementById('confirm-stream').value;
  await addFromOmdbWithChoices(pendingHit, typeSel, streamSel);
  pendingHit=null;
  closeAddModal();
  hideSuggest();
  document.getElementById('add-search').value='';
}

async function addFromOmdbWithChoices(hit, typeSel, streamSel){
  const map={movie:'film',series:'serie'};
  const item={
    id:'id-'+Date.now()+'-'+Math.random().toString(36).slice(2,7),
    title:hit.Title, type:typeSel || (map[hit.Type]||'film'),
    createdAt:Date.now(),
    imdbRating:'', year:hit.Year||'', runtime:'',
    poster: (hit.Poster && hit.Poster!=='N/A')?hit.Poster:'',
    streamingOn: normalizeStream(streamSel), ourScore:'', dateSeen:'',
    imdbID:hit.imdbID||''
  };
  await dbPut(item);
  setStatus(`Toegevoegd: ${item.title}`);
  app.state.items=await dbGetAll(); app.render();
}

function showRandom(item){
  const bd=document.getElementById('random-backdrop');
  const md=document.getElementById('random-modal');
  document.getElementById('rnd-title').textContent=item.title||'—';
  document.getElementById('rnd-meta').textContent = `IMDb: ${item.imdbRating||'N/B'} · ${item.year||''}`;
  document.getElementById('rnd-stream').textContent = normalizeStream(item.streamingOn)?`Beschikbaar op ${normalizeStream(item.streamingOn)}`:'';
  document.getElementById('rnd-poster').src=(item.poster&&item.poster!=='N/A')?poster(item.poster,240,360):PLACEHOLDER;
  const close=()=>{bd.style.display='none'; md.style.display='none'};
  document.getElementById('rnd-ok').onclick=close;
  bd.onclick=close;
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); }, {once:true});
  bd.style.display='block'; md.style.display='flex';
}

app.importJSON=function(){
  const picker=document.createElement('input'); picker.type='file'; picker.accept='application/json';
  picker.onchange=()=>{(async()=>{
    try{
      const f=picker.files[0]; if(!f) return;
      const text=await f.text(); let data=JSON.parse(text);
      let arr=Array.isArray(data)?data:(Array.isArray(data.items)?data.items:[]);
      if(!arr.length){alert('Leeg JSON-bestand.');return}
      let ins=0,upd=0;
      const all=await dbGetAll();
      for(const raw of arr){
        const existing = all.find(x=> (x.imdbID && x.imdbID===raw.imdbID) || (x.title===raw.title && x.type===raw.type));
        const item={
          id: existing?.id || raw.id || ('id-'+Date.now()+'-'+Math.random().toString(36).slice(2,7)),
          title: raw.title||existing?.title||'Onbekend',
          type: raw.type||existing?.type||'film',
          createdAt: existing?.createdAt || raw.createdAt || Date.now(),
          imdbRating: raw.imdbRating || existing?.imdbRating || '',
          year: raw.year || existing?.year || '',
          runtime: raw.runtime || existing?.runtime || '',
          poster: (raw.poster && raw.poster!=='N/A') ? raw.poster : (existing?.poster||''),
          streamingOn: normalizeStream(raw.streamingOn||raw.stream||existing?.streamingOn||''),
          ourScore: (raw.ourScore==null || String(raw.ourScore).toLowerCase()==='nan') ? (existing?.ourScore||'') : String(raw.ourScore),
          dateSeen: raw.dateSeen || existing?.dateSeen || '',
          imdbID: raw.imdbID || raw.imdbId || existing?.imdbID || ''
        };
        if(existing){ upd++; } else { ins++; }
        await dbPut(item);
      }
      app.state.items=await dbGetAll(); app.render();
      alert(`Import klaar. Nieuw: ${ins} · Bijgewerkt: ${upd}`);
    }catch(e){console.error(e); alert('Import fout.');}
  })()}; picker.click();
};

document.addEventListener('DOMContentLoaded',async()=>{
  bindUI();
  await ensurePersistent(); // vraag browser om persistent storage
  try{
    app.state.items = await dbGetAll();
    if(!app.state.items.length){
      setStatus('Eerste run op deze locatie — herstellen uit /data…');
      // bootstrap function is kept minimal here to avoid duplicates; JSONs already normalized
      const files=['data/aanhetkijken.json','data/films.json','data/series.json','data/herman-film.json','data/herman-serie.json'];
      let total=0;
      for(const file of files){
        try{
          const res=await fetch(file);
          if(!res.ok) continue;
          const json=await res.json();
          const arr=Array.isArray(json)?json:(json.items||[]);
          for(const raw of arr){
            const item={
              id: raw.id || 'id-'+Date.now()+'-'+Math.random().toString(36).slice(2,7),
              title: raw.title || 'Onbekend',
              type: raw.type || 'film',
              createdAt: raw.createdAt || Date.now(),
              imdbRating: raw.imdbRating || '',
              year: raw.year || '',
              runtime: raw.runtime || '',
              poster: (raw.poster && raw.poster!=='N/A')?raw.poster:'',
              streamingOn: normalizeStream(raw.streamingOn||raw.stream||''),
              ourScore: (raw.ourScore==null || String(raw.ourScore).toLowerCase()==='nan')?'':String(raw.ourScore),
              dateSeen: raw.dateSeen || '',
              imdbID: raw.imdbID || raw.imdbId || ''
            };
            await dbPut(item); total++;
          }
        }catch(e){}
      }
      app.state.items = await dbGetAll();
      setStatus(`Herstel klaar (${total} items).`);
    }else{
      setStatus(`v3.17 actief — ${app.state.items.length} items geladen`);
    }
    app.render();
  }catch(e){
    console.error(e); setStatus('Kon lokale data niet laden.');
  }
});
</script>
</body>
</html>
