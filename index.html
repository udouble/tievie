<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tievie</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and smooth transitions */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Fallback */
            background-image: radial-gradient(circle at 10% 20%, rgb(0, 119, 182, 0.8) 0%, rgb(251, 133, 0, 0.6) 90%);
            min-height: 100vh;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        /* Glassmorphism Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-glass {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        /* Styling for the loading spinner */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Stijl voor uitgeschakelde importknop */
        #import-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
    </style>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // Expose Firebase functions to the global script
        window.firebase = {
            initializeApp,
            getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, writeBatch, getDocs,
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged
        };

        // Unique configuration for the Tievie project
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyAOZYymPIgd_Y_G5ZYcfyid1Y1HCR4wCk8",
            authDomain: "tievie.firebaseapp.com",
            projectId: "tievie",
            storageBucket: "tievie.firebasestorage.app",
            messagingSenderId: "740661360533",
            appId: "1:740661360533:web:bf16234d6b104aafd7289c",
            measurementId: "G-GLREHKYM9D"
        });
        
        // Set the global App ID based on the projectId for Firestore path matching
        window.__app_id = JSON.parse(window.__firebase_config).projectId;

    </script>
</head>
<body class=" text-slate-800">

    <!-- Main Container -->
    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8 flex flex-col sm:flex-row items-center justify-center gap-4">
            <div class="flex items-center gap-3">
                <svg class="h-12 w-12 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2Z" fill="url(#paint0_linear_1_2)"/><path d="M15.5 10.5L10.5 15.5L8.5 13.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><defs><linearGradient id="paint0_linear_1_2" x1="2" y1="2" x2="22" y2="22" gradientUnits="userSpaceOnUse"><stop stop-color="#FB8500"/><stop offset="1" stop-color="#0077B6"/></linearGradient></defs></svg>
                <h1 class="text-5xl font-bold text-white tracking-tight" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">Tievie</h1>
            </div>
            <p class="text-white/80 sm:border-l-2 sm:pl-4 sm:ml-4 border-white/30">Uw persoonlijke film- en seriegids</p>
        </header>

        <!-- Search Controls -->
        <div class="glass-card p-6 rounded-2xl shadow-lg mb-8 max-w-4xl mx-auto">
            <div class="flex flex-col md:flex-row gap-4 md:gap-6">
                <div class="relative flex-grow">
                    <input type="text" id="item-input" placeholder="Zoek een titel om toe te voegen..." autocomplete="off" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none transition-all">
                    <div id="suggestions-container" class="absolute z-30 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg hidden max-h-96 overflow-y-auto"></div>
                </div>
                <div class="relative flex-grow">
                    <input type="text" id="search-input" placeholder="Zoek in uw lijsten..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none transition-all">
                </div>
            </div>
        </div>
        
        <!-- Filter Controls, Randomizer & Sort -->
        <div class="glass-card p-4 rounded-2xl max-w-6xl mx-auto mb-8">
            <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                <div class="flex justify-center items-center gap-2 flex-wrap" id="filter-controls">
                    <button data-filter="all" class="filter-btn active bg-indigo-600 text-white font-semibold px-4 py-2 rounded-full text-sm transition-all">Alles</button>
                    <button data-filter="film" class="filter-btn bg-white/50 text-slate-800 font-semibold px-4 py-2 rounded-full text-sm transition-all hover:bg-white/80">Films</button>
                    <button data-filter="serie" class="filter-btn bg-white/50 text-slate-800 font-semibold px-4 py-2 rounded-full text-sm transition-all hover:bg-white/80">Series</button>
                    <button data-filter="aan-het-kijken" class="filter-btn bg-white/50 text-slate-800 font-semibold px-4 py-2 rounded-full text-sm transition-all hover:bg-white/80">Aan het kijken</button>
                    <button data-filter="herman-film" class="filter-btn bg-white/50 text-slate-800 font-semibold px-4 py-2 rounded-full text-sm transition-all hover:bg-white/80">H-Film</button>
                    <button data-filter="herman-serie" class="filter-btn bg-white/50 text-slate-800 font-semibold px-4 py-2 rounded-full text-sm transition-all hover:bg-white/80">H-Serie</button>
                    <button data-filter="bekeken" class="filter-btn bg-white/50 text-slate-800 font-semibold px-4 py-2 rounded-full text-sm transition-all hover:bg-white/80">Bekeken</button>
                    
                    <!-- NIEUWE POSTER KNOP (verborgen, alleen voor toekomstig gebruik) -->
                    <button id="poster-update-btn" class="bg-yellow-500/80 text-yellow-900 font-semibold px-4 py-2 rounded-full text-sm transition-all hover:bg-yellow-600/90 hidden">
                        Posters Ophalen (Eenmalig)
                    </button>

                    <!-- IMPORT KNOP IS NU WEER HIER, EN ZOU ZICHTBAAR MOETEN BLIJVEN -->
                    <button id="import-btn" class="bg-red-600 text-white font-semibold px-4 py-2 rounded-full text-sm transition-all hover:bg-red-700">
                        Importeer 13 Items (Aan het kijken)
                    </button>
                </div>
                
                <div class="flex items-center gap-2 flex-wrap justify-center">
                    <div id="randomizer-container" class="hidden">
                         <button id="random-btn" title="Kies een willekeurige titel" class="flex items-center gap-2 bg-white/80 text-slate-800 font-semibold px-3 py-2 rounded-full text-sm transition-all hover:bg-white border border-slate-300">
                             <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5a.75.75 0 01.75.75v.313c0 .324.238.604.557.712a10.461 10.461 0 014.223 2.506c.21.18.496.222.753.107a.75.75 0 01.884 1.152 11.96 11.96 0 00-3.1 3.868c-.12.256-.07.567.123.758a10.461 10.461 0 012.506 4.223c.108.32.388.557.712.557h.313a.75.75 0 010 1.5h-.313c-.324 0-.604.238-.712.557a10.461 10.461 0 01-2.506 4.223c-.18.21-.222.496-.107.753a.75.75 0 01-1.152.884 11.96 11.96 0 00-3.868-3.1c-.256-.12-.567-.07-.758.123a10.461 10.461 0 01-4.223 2.506c-.32.108-.557.388-.557.712v.313a.75.75 0 01-1.5 0v-.313c0-.324-.238-.604-.557-.712a10.461 10.461 0 01-4.223-2.506c-.21-.18-.496-.222-.753-.107a.75.75 0 01-.884-1.152 11.96 11.96 0 003.1-3.868c.12-.256.07-.567-.123-.758a10.461 10.461 0 01-2.506-4.223c-.108-.32-.388-.557-.712-.557H3a.75.75 0 010-1.5h.313c.324 0 .604-.238.712-.557a10.461 10.461 0 012.506-4.223c.18-.21.222-.496.107-.753a.75.75 0 011.152-.884 11.96 11.96 0 003.868 3.1c.256.12.567.07.758-.123a10.461 10.461 0 014.223-2.506c.32-.108.557-.388.557-.712V3.25a.75.75 0 01.75-.75zM12 9a3 3 0 100 6 3 3 0 000-6z"/></svg>
                             <span id="random-btn-text">Kies</span>
                         </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="sort-by" class="p-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:outline-none">
                            <option value="default">Sorteer: Nieuwste</option>
                            <option value="title-asc">Sorteer: Titel</option>
                            <option value="imdb-desc">Sorteer: IMDb Score</option>
                            <option value="ourscore-desc">Sorteer: Onze Score</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Random Item View -->
        <div id="random-view-container" class="text-center hidden mb-8">
            <button id="show-full-list-btn" class="bg-amber-500 text-white font-semibold px-6 py-3 rounded-lg hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-all shadow">
                Toon volledige lijst
            </button>
        </div>

        <!-- Item Grid -->
        <div id="item-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Items will be dynamically inserted here -->
        </div>
        
        <p id="empty-state" class="text-center text-white/80 py-10 hidden col-span-full">Verbinden met de database...</p>

    </div>
    
    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-30 hidden z-40"></div>

    <div id="add-details-modal" class="modal-glass fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-8 max-w-lg w-full rounded-2xl shadow-2xl hidden transition-all z-50">
        <h2 class="text-2xl font-bold mb-2">Details Toevoegen</h2>
        <p id="modal-item-title" class="font-semibold text-lg text-slate-700 mb-6"></p>
        <div class="space-y-4">
            <div>
                <label for="modal-type-select" class="block text-sm font-medium text-slate-700 mb-1">Categorie</label>
                <select id="modal-type-select" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none transition-all">
                    <option value="film">Films</option>
                    <option value="serie">Series</option>
                    <option value="aan-het-kijken">Aan het kijken</option>
                    <option value="herman-film">H-Film</option>
                    <option value="herman-serie">H-Serie</option>
                    <option value="bekeken">Bekeken</option>
                </select>
            </div>
            <div>
                <label for="modal-streaming-select" class="block text-sm font-medium text-slate-700 mb-1">Waar te bekijken</label>
                <select id="modal-streaming-select" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none transition-all">
                </select>
            </div>
        </div>
        <div class="flex justify-end gap-4 mt-8">
            <button id="cancel-add-btn" class="bg-slate-200 text-slate-800 font-semibold px-6 py-3 rounded-lg hover:bg-slate-300 transition-all">Annuleren</button>
            <button id="confirm-add-btn" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 transition-all">Definitief Toevoegen</button>
        </div>
    </div>
    
    <div id="imdb-info-modal" class="modal-glass fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-8 max-w-2xl w-full rounded-2xl shadow-2xl hidden transition-all z-50 max-h-[80vh] overflow-y-auto">
        <!-- Content will be injected here -->
    </div>

    <div id="delete-modal" class="modal-glass fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-8 max-w-sm w-full rounded-2xl shadow-2xl text-center hidden transition-all z-50">
        <h2 class="text-2xl font-bold mb-4">Weet je het zeker?</h2>
        <p class="text-slate-600 mb-8">Dit item wordt permanent verwijderd.</p>
        <div class="flex justify-center gap-4">
            <button id="cancel-delete" class="bg-slate-200 text-slate-800 font-semibold px-6 py-3 rounded-lg hover:bg-slate-300 transition-all">Annuleren</button>
            <button id="confirm-delete" class="bg-red-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-red-700 transition-all">Verwijderen</button>
        </div>
    </div>

    <script>
        const app = {
            // Application State
            state: {
                items: [],
                filter: 'all',
                sortBy: 'default',
                randomlySelectedItem: null,
                itemToDelete: null,
                apiKey: '8a70a767', // OMDb API Key
                appId: null,
                searchTimeout: null,
                selectedItemForAddition: null,
                db: null,
                auth: null,
                userId: null,
                isDbReady: false,
                // ENKEL DATA UIT 'AAN HET KIJKEN.XLSX' (13 items)
                importData: [
                    { "title": "Apple Cider Vinegar", "imdbID": "tt30428143", "type": "aan-het-kijken", "streamingOn": "Netflix", "imdbRating": "7.2", "runtime": "60 mins", "year": "2025", "poster": "https://placehold.co/400x600/e2e8f0/94a3b8?text=Laden...", "ourScore": "", "dateSeen": "", "createdAt": 1727732400000 },
                    { "title": "Dag & nacht", "imdbID": "tt27192052", "type": "aan-het-kijken", "streamingOn": "Streamz", "imdbRating": "8.2", "runtime": "N/A", "year": "2023", "poster": "https://placehold.co/400x600/e2e8f0/94a3b8?text=Laden...", "ourScore": "", "dateSeen": "", "createdAt": 1727732400001 },
                    { "title": "Holy Sh!t", "imdbID": "tt35067773", "type": "aan-het-kijken", "streamingOn": "Streamz", "imdbRating": "8.0", "runtime": "N/A", "year": "2025", "poster": "https://placehold.co/400x600/e2e8f0/94a3b8?text=Laden...", "ourScore": "", "dateSeen": "", "createdAt": 1727732400002 },
                    { "title": "Obsession", "imdbID": "tt18831118", "type": "aan-het-kijken", "streamingOn": "Netflix", "imdbRating": "5.2", "runtime": "40 mins", "year": "2023", "poster": "https://placehold.co/400x600/e2e8f0/94a3b8?text=Laden...", "ourScore": "", "dateSeen": "", "createdAt": 1727732400003 },
                    { "title": "Reservatet", "imdbID": "tt33496221", "type": "aan-het-kijken", "streamingOn": "Netflix", "imdbRating": "7.0", "runtime": "35 mins", "year": "2025", "poster": "https://placehold.co/400x600/e2e8f0/94a3b8?text=Laden...", "ourScore": "", "dateSeen": "", "createdAt": 1727732400004 },
                    { "title": "The Diamond Heist", "imdbID": "tt31806040", "type": "aan-het-kijken", "streamingOn": "Netflix", "imdbRating": "7.0", "runtime": "45 mins", "year": "2025", "poster": "https://placehold.co/400x600/e2e8f0/94a3b8?text=Laden...", "ourScore": "", "dateSeen": "", "createdAt": 1727732400005 },
                    { "title": "The Borgias", "imdbID": "tt1582457", "type": "aan-het-kijken", "streamingOn": "Streamz", "imdbRating": "7.9", "runtime": "50 mins", "year": "2011", "poster": "https://placehold.co/400x600/e2e8f0/94a3b8?text=Laden...", "ourScore": "", "dateSeen": "", "createdAt": 1727732400006 },
                    { "title": "The Capture", "imdbID": "tt8219740", "type": "aan-het-kijken", "streamingOn": "Streamz", "imdbRating": "7.7", "runtime": "60 mins", "year": "2019", "poster": "https://placehold.co/400x600/e2e8f0/94a3b8?text=Laden...", "ourScore": "", "dateSeen": "", "createdAt": 1727732400007 },
                    { "title": "The Offer", "imdbID": "tt15147816", "type": "aan-het-kijken", "streamingOn": "Streamz", "imdbRating": "8.5", "runtime": "60 mins", "year": "2022", "poster": "https://placehold.co/400x600/e2e8f0/94a3b8?text=Laden...", "ourScore": "", "dateSeen": "", "createdAt": 1727732400008 },
                    { "title": "The Last Kingdom", "imdbID": "tt4179452", "type": "aan-het-kijken", "streamingOn": "Netflix", "imdbRating": "8.5", "runtime": "60 mins", "year": "2015", "poster": "https://placehold.co/400x600/e2e8f0/94a3b8?text=Laden...", "ourScore": "", "dateSeen": "", "createdAt": 1727732400009 },
                    { "title": "The Big Door Prize", "imdbID": "tt14828690", "type": "aan-het-kijken", "streamingOn": "Apple TV+", "imdbRating": "7.1", "runtime": "30 mins", "year": "2023", "poster": "https://placehold.co/400x600/e2e8f0/94a3b8?text=Laden...", "ourScore": "", "dateSeen": "", "createdAt": 1727732400010 },
                    { "title": "Pachinko", "imdbID": "tt8887968", "type": "aan-het-kijken", "streamingOn": "Apple TV+", "imdbRating": "8.5", "runtime": "60 mins", "year": "2022", "poster": "https://placehold.co/400x600/e2e8f0/94a3b8?text=Laden...", "ourScore": "", "dateSeen": "", "createdAt": 1727732400011 },
                    { "title": "Foundation", "imdbID": "tt2080373", "type": "aan-het-kijken", "streamingOn": "Apple TV+", "imdbRating": "7.5", "runtime": "60 mins", "year": "2021", "poster": "https://placehold.co/400x600/e2e8f0/94a3b8?text=Laden...", "ourScore": "", "dateSeen": "", "createdAt": 1727732400012 }
                ],
            },

            // Constants
            streamingServices: ["Netflix", "Streamz", "Disney+", "Prime", "VRT Max", "Niet gespecificeerd"],
            PillarTypeMap: {
                'film': { label: 'Te bekijken film', color: 'bg-indigo-600' },
                'serie': { label: 'Te bekijken serie', color: 'bg-cyan-600' },
                'aan-het-kijken': { label: 'Aan het kijken', color: 'bg-yellow-600' },
                'herman-film': { label: 'Herman film', color: 'bg-orange-600' },
                'herman-serie': { label: 'Herman serie', color: 'bg-red-600' },
                'bekeken': { label: 'Bekeken', color: 'bg-green-600' }
            },

            // DOM Elements (Initialized in initApp)
            elements: {},

            // --- Utility Functions ---

            // Initialiseert alle DOM elementen
            initializeElements() {
                app.elements.itemList = document.getElementById('item-list');
                app.elements.itemInput = document.getElementById('item-input');
                app.elements.searchInput = document.getElementById('search-input');
                app.elements.suggestionsContainer = document.getElementById('suggestions-container');
                app.elements.filterControls = document.getElementById('filter-controls');
                app.elements.sortBySelect = document.getElementById('sort-by');
                app.elements.emptyState = document.getElementById('empty-state');
                app.elements.importBtn = document.getElementById('import-btn'); // Nu in filterbalk
                app.elements.posterUpdateBtn = document.getElementById('poster-update-btn');
                
                // Modals
                app.elements.modalBackdrop = document.getElementById('modal-backdrop');
                app.elements.addDetailsModal = document.getElementById('add-details-modal');
                app.elements.imdbInfoModal = document.getElementById('imdb-info-modal');
                app.elements.deleteModal = document.getElementById('delete-modal');
                
                // Add Details Modal Controls
                app.elements.modalItemTitle = document.getElementById('modal-item-title');
                app.elements.modalTypeSelect = document.getElementById('modal-type-select');
                app.elements.modalStreamingSelect = document.getElementById('modal-streaming-select');
                app.elements.confirmAddBtn = document.getElementById('confirm-add-btn');
                app.elements.cancelAddBtn = document.getElementById('cancel-add-btn');

                // Delete Modal Controls
                app.elements.confirmDeleteBtn = document.getElementById('confirm-delete');
                app.elements.cancelDeleteBtn = document.getElementById('cancel-delete');
                
                // Randomizer
                app.elements.randomBtn = document.getElementById('random-btn');
                app.elements.randomBtnText = document.getElementById('random-btn-text');
                app.elements.randomizerContainer = document.getElementById('randomizer-container'); 
                app.elements.randomViewContainer = document.getElementById('random-view-container');
                app.elements.showFullListBtn = document.getElementById('show-full-list-btn');
            },


            showModal(modalElement) {
                app.elements.modalBackdrop.classList.remove('hidden');
                modalElement.classList.remove('hidden');
            },

            hideModal(modalElement) {
                app.elements.modalBackdrop.classList.add('hidden');
                modalElement.classList.add('hidden');
            },

            getPillarClass(type) {
                return app.PillarTypeMap[type] ? app.PillarTypeMap[type].color : 'bg-gray-400';
            },

            getPillarLabel(type) {
                return app.PillarTypeMap[type] ? app.PillarTypeMap[type].label : 'Onbekend';
            },

            getScoreColor(score) {
                const s = parseFloat(score);
                if (s >= 8.0) return 'bg-green-500';
                if (s >= 7.0) return 'bg-lime-500';
                if (s >= 6.0) return 'bg-yellow-500';
                return 'bg-red-500';
            },

            // --- Firebase Operations ---
            
            async initFirebase() {
                try {
                    const firebaseConfig = JSON.parse(window.__firebase_config);
                    app.state.appId = window.__app_id;
                    const firebaseApp = firebase.initializeApp(firebaseConfig);
                    app.state.db = firebase.getFirestore(firebaseApp);
                    app.state.auth = firebase.getAuth(firebaseApp);

                    firebase.onAuthStateChanged(app.state.auth, async (user) => {
                        if (user) {
                            app.state.userId = user.uid;
                        } else {
                            const anonymousUser = await firebase.signInAnonymously(app.state.auth);
                            app.state.userId = anonymousUser.user.uid;
                        }
                        app.state.isDbReady = true;
                        app.elements.emptyState.textContent = 'Laden van uw filmcollectie...';
                        app.elements.emptyState.classList.remove('hidden');
                        app.startDataListener();
                    });
                } catch (error) {
                    console.error("Firebase init failed:", error);
                    app.elements.emptyState.textContent = 'Fout bij het verbinden met database.';
                }
            },

            getCollectionPath() {
                // Private data path: /artifacts/{appId}/users/{userId}/items
                return `artifacts/${app.state.appId}/users/${app.state.userId}/items`;
            },

            // Deze functie regelt de status van de importknop NA het laden van de data
            startDataListener() {
                if (!app.state.db || !app.state.userId) {
                    console.warn("Database or User ID not ready for listener.");
                    return;
                }

                const itemsCollection = firebase.collection(app.state.db, app.getCollectionPath());
                
                // Real-time listener
                firebase.onSnapshot(itemsCollection, (snapshot) => {
                    app.state.items = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    app.state.items.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)); // Sort by newest first (default)
                    app.renderItems();
                    
                    const listIsNotEmpty = app.state.items.length > 0;
                    
                    // PAS DE KNOP AAN NADAT WE DE DEFINITIEVE STAAT WETEN
                    if (listIsNotEmpty) {
                        // Deactiveer de knop als er data is
                        app.elements.importBtn.disabled = true;
                        app.elements.importBtn.textContent = `Import voltooid (${app.state.items.length} items geladen)`;
                        
                        if (app.elements.randomizerContainer) {
                            app.elements.randomizerContainer.classList.remove('hidden');
                        }
                        app.elements.emptyState.classList.add('hidden'); 
                    } else {
                        // Zorg ervoor dat de knop actief blijft, en de tekst correct is
                        app.elements.importBtn.disabled = false;
                        app.elements.importBtn.textContent = `Importeer ${app.state.importData.length} Items (Aan het kijken)`;
                        
                        if (app.elements.randomizerContainer) {
                            app.elements.randomizerContainer.classList.add('hidden');
                        }
                        app.elements.emptyState.textContent = 'Uw lijst is leeg. Zoek hierboven een titel om toe te voegen, of gebruik de import-knop.';
                        app.elements.emptyState.classList.remove('hidden');
                    }
                    
                }, (error) => {
                    console.error("Firestore listener failed:", error);
                    app.elements.emptyState.textContent = 'Fout bij het laden van data: ' + error.message;
                });
            },

            async saveItem(itemData) {
                if (!app.state.db || !app.state.userId) return;
                try {
                    const itemsCollection = firebase.collection(app.state.db, app.getCollectionPath());
                    await firebase.addDoc(itemsCollection, {
                        ...itemData,
                        createdAt: Date.now()
                    });
                } catch (error) {
                    console.error("Error adding document: ", error);
                }
            },

            async deleteItem(id) {
                if (!app.state.db || !app.state.userId) return;
                try {
                    const docRef = firebase.doc(app.state.db, app.getCollectionPath(), id);
                    await firebase.deleteDoc(docRef);
                } catch (error) {
                    console.error("Error deleting document: ", error);
                }
            },

            async updateItem(id, data) {
                if (!app.state.db || !app.state.userId) return;
                try {
                    const docRef = firebase.doc(app.state.db, app.getCollectionPath(), id);
                    await firebase.updateDoc(docRef, data);
                } catch (error) {
                    console.error("Error updating document: ", error);
                }
            },

            // --- OMDb API & Search Logic ---

            async searchOmdb(query) {
                if (!query) return [];
                // Search for both movie and series types
                const url = `https://www.omdbapi.com/?s=${encodeURIComponent(query)}&apikey=${app.state.apiKey}&type=movie`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.Response === "True") {
                        // Filter out titles already in the list to avoid duplicates in suggestions
                        const existingImdbIDs = new Set(app.state.items.map(item => item.imdbID));
                        return data.Search.filter(result => !existingImdbIDs.has(result.imdbID) && result.Poster !== 'N/A');
                    }
                    return [];
                } catch (error) {
                    console.error("Error fetching OMDb data:", error);
                    return [];
                }
            },

            async fetchImdbData(imdbID) {
                const url = `https://www.omdbapi.com/?i=${imdbID}&apikey=${app.state.apiKey}&plot=full`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.Response === "True") {
                        return {
                            title: data.Title,
                            year: data.Year,
                            poster: data.Poster !== 'N/A' ? data.Poster : 'https://placehold.co/400x600/e2e8f0/94a3b8?text=Geen+Poster',
                            imdbID: data.imdbID,
                            imdbRating: data.imdbRating === 'N/A' ? '' : data.imdbRating,
                            runtime: data.Runtime === 'N/A' ? '' : data.Runtime,
                            genre: data.Genre === 'N/A' ? '' : data.Genre,
                            plot: data.Plot === 'N/A' ? 'Geen plot beschikbaar.' : data.Plot,
                            director: data.Director === 'N/A' ? '' : data.Director,
                            actors: data.Actors === 'N/A' ? '' : data.Actors,
                            awards: data.Awards === 'N/A' ? '' : data.Awards
                        };
                    }
                    return null;
                } catch (error) {
                    console.error("Error fetching detailed OMDb data:", error);
                    return null;
                }
            },

            // --- Rendering & UI Logic ---
            
            renderSuggestions(suggestions) {
                app.elements.suggestionsContainer.innerHTML = '';
                if (suggestions.length === 0) {
                    app.elements.suggestionsContainer.classList.add('hidden');
                    return;
                }
                
                app.elements.suggestionsContainer.classList.remove('hidden');

                suggestions.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center p-3 cursor-pointer hover:bg-slate-100 transition-colors border-b border-slate-100 last:border-b-0';
                    div.innerHTML = `
                        <img src="${item.Poster}" alt="${item.Title}" class="w-10 h-14 object-cover rounded-md shadow mr-3 onerror="this.src='https://placehold.co/400x600/e2e8f0/94a3b8?text=Geen+Poster'">
                        <div>
                            <p class="font-semibold text-sm text-slate-800">${item.Title}</p>
                            <p class="text-xs text-slate-500">${item.Year} (${item.Type})</p>
                        </div>
                    `;
                    div.onclick = () => app.handleSuggestionClick(item);
                    app.elements.suggestionsContainer.appendChild(div);
                });
            },

            renderItemCard(item) {
                const pillar = app.getPillarClass(item.type);
                const pillarLabel = app.getPillarLabel(item.type);
                const ourScoreColor = app.getScoreColor(item.ourScore);
                const imdbScoreColor = app.getScoreColor(item.imdbRating);
                
                // Show score edit field only if category is 'bekeken' (watched)
                const scoreField = item.type === 'bekeken' ? `
                    <div class="relative w-full">
                        <input type="number" min="1" max="10" step="0.1" value="${item.ourScore || ''}" 
                            data-id="${item.id}" data-field="ourScore" 
                            placeholder="Score (1-10)"
                            class="edit-score-input p-1.5 w-full text-center text-xs font-semibold rounded-lg ${ourScoreColor} text-white transition-all focus:ring-2 focus:ring-white/80 focus:outline-none placeholder-white/80"
                        >
                    </div>` : '';
                
                // Set default action button based on list type
                let actionBtnHTML = '';
                if (item.type !== 'bekeken') {
                    actionBtnHTML = `
                        <button data-id="${item.id}" class="move-to-watched flex-1 bg-green-500/80 text-white font-semibold text-xs py-2 rounded-lg hover:bg-green-600 transition-all">
                            Bekeken
                        </button>`;
                }

                const cardHTML = `
                    <div id="card-${item.id}" class="glass-card flex flex-col rounded-xl overflow-hidden shadow-xl hover:shadow-2xl transform hover:scale-[1.01] transition-all relative">
                        <!-- Type Pillar -->
                        <div class="absolute top-0 left-0 ${pillar} text-white text-xs font-bold px-3 py-1 rounded-br-lg z-10 shadow-md">
                            ${pillarLabel}
                        </div>
                        
                        <!-- Actions Menu (dots) -->
                        <div class="absolute top-2 right-2 z-20">
                            <button data-id="${item.id}" class="options-btn text-white bg-black/30 p-1 rounded-full hover:bg-black/50 transition-all">
                                <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                            </button>
                            <div data-id="${item.id}" class="options-menu absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl hidden z-30 overflow-hidden">
                                <button data-id="${item.id}" data-action="details" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 transition-colors">Toon Details (IMDb)</button>
                                <button data-id="${item.id}" data-action="edit" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 transition-colors">Wijzig Categorie</button>
                                <button data-id="${item.id}" data-action="delete" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors">Verwijder</button>
                            </div>
                        </div>

                        <!-- Poster and Info -->
                        <div class="relative">
                            <img src="${item.poster}" alt="${item.title}" class="w-full h-96 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x600/e2e8f0/94a3b8?text=Geen+Poster'">
                            
                            <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent p-4 flex flex-col justify-end">
                                <h3 class="text-xl font-bold text-white mb-1 leading-tight">${item.title} (${item.year})</h3>
                                <p class="text-xs text-white/80 mb-2">${item.runtime || 'N/A'}</p>
                            </div>

                             <!-- IMDb Rating Badge -->
                            <span class="absolute bottom-4 right-4 ${imdbScoreColor} text-white text-xs font-bold px-2.5 py-1 rounded-full shadow-md z-10">
                                IMDb: ${item.imdbRating || 'N/A'}
                            </span>
                        </div>

                        <!-- Score & Actions -->
                        <div class="p-4 bg-white/90">
                            <div class="flex items-center justify-between gap-3">
                                ${scoreField}
                                ${actionBtnHTML}
                            </div>
                            <p class="text-xs text-slate-500 mt-2 text-center">Toegevoegd: ${new Date(item.createdAt).toLocaleDateString()}</p>
                        </div>
                    </div>
                `;
                return cardHTML;
            },

            renderItems() {
                const filtered = app.filterItems(app.state.items);
                const sorted = app.sortItems(filtered);
                
                app.elements.itemList.innerHTML = '';
                
                if (sorted.length === 0 && app.state.items.length > 0) {
                    app.elements.itemList.innerHTML = `<p class="text-center text-white/80 py-10 col-span-full">Geen items gevonden die overeenkomen met de huidige filters of zoekopdracht.</p>`;
                }
                
                sorted.forEach(item => {
                    const card = document.createElement('div');
                    card.innerHTML = app.renderItemCard(item);
                    app.elements.itemList.appendChild(card.firstChild);
                });
                
                // Re-attach event listeners after rendering
                app.attachCardListeners();
            },

            filterItems(items) {
                const { filter } = app.state;
                const searchTerm = app.elements.searchInput.value.toLowerCase().trim();

                const filteredByList = items.filter(item => {
                    if (filter === 'all') return true;
                    return item.type === filter;
                });

                if (searchTerm === '') return filteredByList;

                return filteredByList.filter(item => {
                    const titleMatch = item.title.toLowerCase().includes(searchTerm);
                    const yearMatch = item.year.includes(searchTerm);
                    const streamingMatch = item.streamingOn.toLowerCase().includes(searchTerm);
                    return titleMatch || yearMatch || streamingMatch;
                });
            },

            sortItems(items) {
                const { sortBy } = app.state;
                
                return [...items].sort((a, b) => {
                    switch (sortBy) {
                        case 'title-asc':
                            return a.title.localeCompare(b.title);
                        case 'imdb-desc':
                            return (parseFloat(b.imdbRating) || 0) - (parseFloat(a.imdbRating) || 0);
                        case 'ourscore-desc':
                            return (parseFloat(b.ourScore) || 0) - (parseFloat(a.ourScore) || 0);
                        case 'default':
                        default:
                            return (b.createdAt || 0) - (a.createdAt || 0); // Newest first
                    }
                });
            },

            // --- Event Handlers ---

            handleSuggestionClick(item) {
                app.state.selectedItemForAddition = item;
                app.elements.itemInput.value = '';
                app.elements.suggestionsContainer.classList.add('hidden');
                
                // Pre-fill Modal
                app.elements.modalItemTitle.textContent = `${item.Title} (${item.Year})`;
                
                // Populate streaming dropdown
                app.elements.modalStreamingSelect.innerHTML = app.streamingServices.map(service => 
                    `<option value="${service}">${service}</option>`
                ).join('');

                app.showModal(app.elements.addDetailsModal);
            },

            async handleConfirmAdd() {
                const item = app.state.selectedItemForAddition;
                const type = app.elements.modalTypeSelect.value;
                const streamingOn = app.elements.modalStreamingSelect.value;

                if (!item) return;

                const detailedData = await app.fetchImdbData(item.imdbID);

                const newItem = {
                    title: item.Title,
                    year: item.Year,
                    imdbID: item.imdbID,
                    type: type,
                    streamingOn: streamingOn,
                    imdbRating: detailedData ? detailedData.imdbRating : (item.imdbRating || ''),
                    runtime: detailedData ? detailedData.runtime : (item.Runtime || ''),
                    poster: detailedData ? detailedData.poster : (item.Poster || 'https://placehold.co/400x600/e2e8f0/94a3b8?text=Geen+Poster'),
                    ourScore: '',
                    dateSeen: ''
                };
                
                await app.saveItem(newItem);
                app.hideModal(app.elements.addDetailsModal);
                app.state.selectedItemForAddition = null;
            },

            handleConfirmDelete() {
                if (app.state.itemToDelete) {
                    app.deleteItem(app.state.itemToDelete);
                    app.hideModal(app.elements.deleteModal);
                    app.state.itemToDelete = null;
                }
            },

            handleMoveToWatched(id) {
                const item = app.state.items.find(i => i.id === id);
                if (item) {
                    app.updateItem(id, {
                        type: 'bekeken',
                        dateSeen: new Date().toISOString().split('T')[0],
                        ourScore: item.ourScore || '' // Keep existing score if present
                    });
                }
            },

            async handleUpdateScore(event) {
                const id = event.target.dataset.id;
                let score = parseFloat(event.target.value);
                
                if (isNaN(score) || score < 1) score = 1;
                if (score > 10) score = 10;
                
                event.target.value = score;
                await app.updateItem(id, { ourScore: score.toString() });
            },

            async handleShowImdbInfo(item) {
                const detailedItem = await app.fetchImdbData(item.imdbID);
                if (!detailedItem) {
                    console.error("Failed to fetch detailed IMDb data.");
                    // Fallback to existing item details if fetch fails
                    const infoModal = app.elements.imdbInfoModal;
                    infoModal.innerHTML = `
                        <button onclick="app.hideModal(app.elements.imdbInfoModal)" class="absolute top-4 right-4 text-white hover:text-slate-200 transition-colors">
                            <svg class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        </button>
                        <div class="flex flex-col md:flex-row gap-6 items-start">
                            <img src="${item.poster}" alt="${item.title}" class="w-32 h-auto object-cover rounded-lg shadow-xl shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/400x600/e2e8f0/94a3b8?text=Geen+Poster'">
                            <div>
                                <h2 class="text-3xl font-bold text-slate-800 mb-2">${item.title} (${item.year})</h2>
                                <div class="flex flex-wrap items-center gap-4 text-sm text-slate-600 mb-4">
                                    <span class="font-semibold ${app.getScoreColor(item.imdbRating)} text-white px-3 py-1 rounded-full shadow">IMDb: ${item.imdbRating || 'N/A'}</span>
                                    <span>${item.runtime || 'N/A'}</span>
                                    <span>${item.streamingOn || 'Niet gespecificeerd'}</span>
                                </div>
                                <p class="text-sm text-slate-700 mb-4">Plot kon niet geladen worden. Probeer het later opnieuw.</p>
                                <p class="text-xs text-slate-500">Beschikbare details zijn beperkt.</p>
                            </div>
                        </div>
                    `;
                    app.showModal(infoModal);
                    return;
                }
                
                const mergedItem = { ...item, ...detailedItem };

                const infoModal = app.elements.imdbInfoModal;
                infoModal.innerHTML = `
                    <button onclick="app.hideModal(app.elements.imdbInfoModal)" class="absolute top-4 right-4 text-white hover:text-slate-200 transition-colors">
                        <svg class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </button>
                    <div class="flex flex-col md:flex-row gap-6 items-start">
                        <img src="${mergedItem.poster}" alt="${mergedItem.title}" class="w-32 h-auto object-cover rounded-lg shadow-xl shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/400x600/e2e8f0/94a3b8?text=Geen+Poster'">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800 mb-2">${mergedItem.title} (${mergedItem.year})</h2>
                            <div class="flex flex-wrap items-center gap-4 text-sm text-slate-600 mb-4">
                                <span class="font-semibold ${app.getScoreColor(mergedItem.imdbRating)} text-white px-3 py-1 rounded-full shadow">IMDb: ${mergedItem.imdbRating || 'N/A'}</span>
                                <span>${mergedItem.runtime || 'N/A'}</span>
                                <span>${mergedItem.streamingOn || 'Niet gespecificeerd'}</span>
                            </div>
                            <p class="text-sm text-slate-700 mb-4">${mergedItem.plot || 'Geen plot beschikbaar.'}</p>
                            <p class="text-xs text-slate-500"><strong>Genre:</strong> ${mergedItem.genre || 'N/A'}</p>
                            <p class="text-xs text-slate-500"><strong>Regisseur:</strong> ${mergedItem.director || 'N/A'}</p>
                            <p class="text-xs text-slate-500"><strong>Acteurs:</strong> ${mergedItem.actors || 'N/A'}</p>
                            <p class="text-xs text-slate-500 mt-2"><strong>Awards:</strong> ${mergedItem.awards || 'N/A'}</p>
                        </div>
                    </div>
                `;
                app.showModal(infoModal);
            },

            handleEditCategory(item) {
                // Pre-fill Modal for editing
                app.state.selectedItemForAddition = item; // Re-use this state variable for simplicity
                app.elements.modalItemTitle.textContent = `${item.title} (${item.year}) - Categorie wijzigen`;
                
                // Populate streaming dropdown
                app.elements.modalStreamingSelect.innerHTML = app.streamingServices.map(service => 
                    `<option value="${service}" ${item.streamingOn === service ? 'selected' : ''}>${service}</option>`
                ).join('');
                
                // Set current category
                app.elements.modalTypeSelect.value = item.type;
                
                // Change button text and temporarily store the original handler
                app.elements.confirmAddBtn.textContent = 'Wijzig Categorie';
                app.elements.confirmAddBtn.onclick = () => app.handleConfirmEditCategory(item.id);
                
                app.showModal(app.elements.addDetailsModal);
            },
            
            async handleConfirmEditCategory(id) {
                const newType = app.elements.modalTypeSelect.value;
                const newStreamingOn = app.elements.modalStreamingSelect.value;
                
                const updateData = { 
                    type: newType, 
                    streamingOn: newStreamingOn 
                };
                
                // If moving *away* from bekeken, clear score/dateSeen
                if (newType !== 'bekeken') {
                    updateData.ourScore = '';
                    updateData.dateSeen = '';
                } else if (!app.state.items.find(i => i.id === id)?.dateSeen) {
                    // If moving *to* bekeken and no date set, set current date
                    updateData.dateSeen = new Date().toISOString().split('T')[0];
                }
                
                await app.updateItem(id, updateData);
                
                // Reset modal state
                app.elements.confirmAddBtn.textContent = 'Definitief Toevoegen';
                app.elements.confirmAddBtn.onclick = app.handleConfirmAdd;
                app.hideModal(app.elements.addDetailsModal);
                app.state.selectedItemForAddition = null;
            },


            handleRandomSelect() {
                const currentItems = app.filterItems(app.state.items);
                if (currentItems.length === 0) {
                    app.elements.randomBtnText.textContent = 'Lijst is leeg!';
                    setTimeout(() => app.elements.randomBtnText.textContent = 'Kies', 2000);
                    return;
                }
                
                app.elements.randomBtn.disabled = true;
                app.elements.randomBtnText.textContent = 'Kiezen...';
                
                // Simple random selection
                const randomIndex = Math.floor(Math.random() * currentItems.length);
                const selectedItem = currentItems[randomIndex];
                app.state.randomlySelectedItem = selectedItem;
                
                // Render only the selected item
                app.elements.itemList.innerHTML = app.renderItemCard(selectedItem);
                
                // Show 'Show full list' button
                app.elements.randomViewContainer.classList.remove('hidden');

                // Reset button after delay
                setTimeout(() => {
                    app.elements.randomBtn.disabled = false;
                    app.elements.randomBtnText.textContent = selectedItem.title;
                    app.attachCardListeners(); // Re-attach listeners for the single card
                }, 1000); 
            },

            handleShowFullList() {
                app.state.randomlySelectedItem = null;
                app.elements.randomBtnText.textContent = 'Kies';
                app.elements.randomViewContainer.classList.add('hidden');
                app.renderItems();
            },

            async handleInitialImport() {
                if (app.elements.importBtn.disabled) {
                    return; // Import is al uitgevoerd
                }

                // Voorkom dubbelklikken door button direct te disablen
                app.elements.importBtn.textContent = `Bezig met importeren (${app.state.importData.length} items)...`;
                app.elements.importBtn.disabled = true;
                
                const itemsCollection = firebase.collection(app.state.db, app.getCollectionPath());

                try {
                    const batch = firebase.writeBatch(app.state.db);
                    
                    for (const item of app.state.importData) {
                        const newDocRef = firebase.doc(itemsCollection); // Auto-generated ID
                        batch.set(newDocRef, {
                            ...item,
                            // Ensure createdAt is a number for sorting
                            createdAt: item.createdAt || Date.now()
                        });
                    }

                    await batch.commit();
                    
                    console.log("Bulk import successful.");
                } catch (error) {
                    console.error("Error performing bulk import:", error);
                    // Herstel knop bij fout
                    app.elements.importBtn.textContent = 'Fout bij importeren. Probeer opnieuw.';
                    app.elements.importBtn.disabled = false;
                }
                // De onSnapshot listener zal de knop na succesvolle import vanzelf deactiveren/tekst aanpassen
            },


            // --- Core App Initialization ---

            attachCardListeners() {
                // Attach listeners for dynamic elements: options menu, actions
                document.querySelectorAll('.options-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        // Hide all other menus
                        document.querySelectorAll('.options-menu').forEach(menu => {
                            if (menu.dataset.id !== btn.dataset.id) {
                                menu.classList.add('hidden');
                            }
                        });
                        // Toggle current menu
                        const menu = document.querySelector(`.options-menu[data-id="${btn.dataset.id}"]`);
                        menu.classList.toggle('hidden');
                    };
                });
                
                document.querySelectorAll('.options-menu button').forEach(menuBtn => {
                    menuBtn.onclick = (e) => {
                        e.stopPropagation();
                        const id = menuBtn.dataset.id;
                        const action = menuBtn.dataset.action;
                        const item = app.state.items.find(i => i.id === id);
                        
                        // Hide the menu immediately
                        menuBtn.closest('.options-menu').classList.add('hidden');
                        
                        if (!item) return;

                        if (action === 'delete') {
                            app.state.itemToDelete = id;
                            app.showModal(app.elements.deleteModal);
                        } else if (action === 'details') {
                            // The implementation of handleShowImdbInfo now fetches data internally
                            app.handleShowImdbInfo(item);
                        
                        } else if (action === 'edit') {
                            app.handleEditCategory(item);
                        }
                    };
                });
                
                document.querySelectorAll('.move-to-watched').forEach(btn => {
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        app.handleMoveToWatched(btn.dataset.id);
                    };
                });

                document.querySelectorAll('.edit-score-input').forEach(input => {
                    // Update score on blur (when input field loses focus)
                    input.onchange = app.handleUpdateScore;
                });
            },

            attachGlobalListeners() {
                // Close options menu/modals when clicking outside
                document.onclick = (e) => {
                    document.querySelectorAll('.options-menu').forEach(menu => {
                        if (!menu.classList.contains('hidden') && !e.target.closest('.options-btn')) {
                            menu.classList.add('hidden');
                        }
                    });
                };
                
                // Hide modals when clicking the backdrop
                app.elements.modalBackdrop.onclick = () => {
                    app.hideModal(app.elements.addDetailsModal);
                    app.hideModal(app.elements.imdbInfoModal);
                    app.hideModal(app.elements.deleteModal);
                    // Reset confirm button handler to original state
                    app.elements.confirmAddBtn.textContent = 'Definitief Toevoegen';
                    app.elements.confirmAddBtn.onclick = app.handleConfirmAdd;
                };

                // Add Details Modal listeners
                app.elements.confirmAddBtn.onclick = app.handleConfirmAdd;
                app.elements.cancelAddBtn.onclick = () => app.elements.modalBackdrop.click(); // Reuse backdrop click logic

                // Delete Modal listeners
                app.elements.confirmDeleteBtn.onclick = app.handleConfirmDelete;
                app.elements.cancelDeleteBtn.onclick = () => app.elements.modalBackdrop.click();
                
                // Search Input (OMDb) listener
                app.elements.itemInput.oninput = () => {
                    clearTimeout(app.state.searchTimeout);
                    const query = app.elements.itemInput.value;
                    if (query.length < 3) {
                        app.elements.suggestionsContainer.classList.add('hidden');
                        return;
                    }

                    app.state.searchTimeout = setTimeout(async () => {
                        const suggestions = await app.searchOmdb(query);
                        app.renderSuggestions(suggestions);
                    }, 300);
                };
                
                // Search Filter (Local) listener
                app.elements.searchInput.oninput = () => {
                    clearTimeout(app.state.searchTimeout);
                    app.state.searchTimeout = setTimeout(() => {
                        app.renderItems();
                    }, 200);
                };
                
                // Filter Button listeners
                app.elements.filterControls.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        app.elements.filterControls.querySelectorAll('.filter-btn').forEach(b => {
                            b.classList.remove('active', 'bg-indigo-600', 'text-white');
                            b.classList.add('bg-white/50', 'text-slate-800', 'hover:bg-white/80');
                        });

                        e.target.classList.add('active', 'bg-indigo-600', 'text-white');
                        e.target.classList.remove('bg-white/50', 'text-slate-800');
                        
                        app.state.filter = e.target.dataset.filter;
                        app.renderItems();
                    };
                });
                
                // Sort Select listener
                app.elements.sortBySelect.onchange = (e) => {
                    app.state.sortBy = e.target.value;
                    app.renderItems();
                };

                // Randomizer listener
                app.elements.randomBtn.onclick = app.handleRandomSelect;
                app.elements.showFullListBtn.onclick = app.handleShowFullList;
                
                // Import button listener
                app.elements.importBtn.onclick = app.handleInitialImport;
            },

            initApp() {
                // 1. Initialize DOM elements first to avoid the TypeError
                app.initializeElements();
                
                // 2. Initialize Firebase and Authentication
                app.initFirebase();
                
                // 3. Attach global event handlers
                app.attachGlobalListeners();
            }
        };

        // Start the application after the window loads
        window.onload = app.initApp;

    </script>
</body>
</html>
